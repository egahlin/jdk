<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/jdk/jfr/jvm/TestGetEventWriter.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="StaticCommitEvent.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tool/TestAssemble.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/jfr/jvm/TestGetEventWriter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2022, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2022, 2025, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 44,11 ***</span>
   * @library /test/lib
   * @modules jdk.internal.vm.ci/jdk.vm.ci.meta
   *          jdk.internal.vm.ci/jdk.vm.ci.runtime
   *
   * @compile PlaceholderEventWriter.java
<span class="line-removed">-  * @compile PlaceholderEventWriterFactory.java</span>
   * @compile E.java
   * @compile NonEvent.java
   * @compile RegisteredTrueEvent.java
   * @compile RegisteredFalseEvent.java
   * @compile MyCommitRegisteredTrueEvent.java
<span class="line-new-header">--- 44,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 78,11 ***</span>
   * @library /test/lib
   * @modules jdk.internal.vm.ci/jdk.vm.ci.meta
   *          jdk.internal.vm.ci/jdk.vm.ci.runtime
   *
   * @compile PlaceholderEventWriter.java
<span class="line-removed">-  * @compile PlaceholderEventWriterFactory.java</span>
   * @compile E.java
   * @compile NonEvent.java
   * @compile RegisteredTrueEvent.java
   * @compile RegisteredFalseEvent.java
   * @compile MyCommitRegisteredTrueEvent.java
<span class="line-new-header">--- 77,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 103,14 ***</span>
              r.start();
              // Unlocks access to jdk.jfr.internal.event
              InitializationEvent e  = new InitializationEvent();
              e.commit();
          }
<span class="line-modified">!         // Make sure EventWriterFactory can be accessed.</span>
<span class="line-modified">!         Class&lt;?&gt; clazz = Class.forName(&quot;jdk.jfr.internal.event.EventWriterFactory&quot;);</span>
          if (clazz == null) {
<span class="line-modified">!             throw new Exception(&quot;Test error, not able to access jdk.jfr.internal.event.EventWriterFactory class&quot;);</span>
          }
          testRegisteredTrueEvent();
          testRegisteredFalseEvent();
          testMyCommitRegisteredTrue();
          testMyCommitRegisteredFalse();
<span class="line-new-header">--- 101,14 ---</span>
              r.start();
              // Unlocks access to jdk.jfr.internal.event
              InitializationEvent e  = new InitializationEvent();
              e.commit();
          }
<span class="line-modified">!         // Make sure EventWriter class can be accessed.</span>
<span class="line-modified">!         Class&lt;?&gt; clazz = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);</span>
          if (clazz == null) {
<span class="line-modified">!             throw new Exception(&quot;Test error, not able to access jdk.jfr.internal.event.EventWriter class&quot;);</span>
          }
          testRegisteredTrueEvent();
          testRegisteredFalseEvent();
          testMyCommitRegisteredTrue();
          testMyCommitRegisteredFalse();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,11 ***</span>
          testNonEvent();
      }
  
      // The class does not inherit jdk.jfr.Event and, as such, does not implement the
      // API. It has its own stand-alone &quot;commit()V&quot;, which is not an override, that
<span class="line-modified">!     // attempts to resolve and link against EventWriterFactory. This user implementation</span>
      // is not blessed for linkage.
      private static void testNonEvent() throws Throwable {
          Runnable e = newEventObject(&quot;NonEvent&quot;);
          try {
              e.run(); // invokes commit()
<span class="line-new-header">--- 118,11 ---</span>
          testNonEvent();
      }
  
      // The class does not inherit jdk.jfr.Event and, as such, does not implement the
      // API. It has its own stand-alone &quot;commit()V&quot;, which is not an override, that
<span class="line-modified">!     // attempts to resolve and link against EventWriter. This user implementation</span>
      // is not blessed for linkage.
      private static void testNonEvent() throws Throwable {
          Runnable e = newEventObject(&quot;NonEvent&quot;);
          try {
              e.run(); // invokes commit()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 176,11 ***</span>
              // methods in jdk.jfr.Event
          }
      }
  
      // The user has implemented another method, &quot;myCommit()V&quot;, not an override nor
<span class="line-modified">!     // overload. that attempts to resolve and link EventWriterFactory. This will fail,</span>
      // because &quot;myCommit()V&quot; is not blessed for linkage.
      private static void testMyCommitRegisteredTrue() throws Throwable {
          Runnable e = newEventObject(&quot;MyCommitRegisteredTrueEvent&quot;);
          try {
              e.run(); // Invoking the user-defined method throws.
<span class="line-new-header">--- 174,11 ---</span>
              // methods in jdk.jfr.Event
          }
      }
  
      // The user has implemented another method, &quot;myCommit()V&quot;, not an override nor
<span class="line-modified">!     // overload. that attempts to resolve and link EventWriter. This will fail,</span>
      // because &quot;myCommit()V&quot; is not blessed for linkage.
      private static void testMyCommitRegisteredTrue() throws Throwable {
          Runnable e = newEventObject(&quot;MyCommitRegisteredTrueEvent&quot;);
          try {
              e.run(); // Invoking the user-defined method throws.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 228,14 ***</span>
  
      static class MethodHandleEvent extends Event {
          public void myCommit() throws Throwable {
              try {
                  Class&lt;?&gt; ew = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);
<span class="line-modified">!                 MethodType t = MethodType.methodType(ew, List.of(long.class));</span>
<span class="line-modified">!                 Class&lt;?&gt; factory = Class.forName(&quot;jdk.jfr.internal.event.EventWriterFactory&quot;);</span>
<span class="line-modified">!                 MethodHandle mh = MethodHandles.lookup().findStatic(factory, &quot;getEventWriter&quot;, t);</span>
<span class="line-removed">-                 mh.invoke(Long.valueOf(4711)); // throws IllegalAccessException</span>
              } catch (ClassNotFoundException | SecurityException e) {
                  throw new RuntimeException(e);
              }
          }
      }
<span class="line-new-header">--- 226,13 ---</span>
  
      static class MethodHandleEvent extends Event {
          public void myCommit() throws Throwable {
              try {
                  Class&lt;?&gt; ew = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);
<span class="line-modified">!                 MethodType t = MethodType.methodType(ew, List.of());</span>
<span class="line-modified">!                 MethodHandle mh = MethodHandles.lookup().findStatic(ew, &quot;getEventWriter&quot;, t);</span>
<span class="line-modified">!                 mh.invoke(); // throws IllegalAccessException</span>
              } catch (ClassNotFoundException | SecurityException e) {
                  throw new RuntimeException(e);
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 260,12 ***</span>
  
      static class ReflectionEvent extends Event {
          public void myCommit() throws Throwable {
              Class&lt;?&gt; c;
              try {
<span class="line-modified">!                 c = Class.forName(&quot;jdk.jfr.internal.event.EventWriterFactory&quot;);</span>
<span class="line-modified">!                 Method m = c.getMethod(&quot;getEventWriter&quot;, new Class[] {long.class});</span>
                  m.invoke(null, Long.valueOf(4711)); // throws InternalError
              } catch (ClassNotFoundException | SecurityException e) {
                  throw new RuntimeException(e);
              }
          }
<span class="line-new-header">--- 257,12 ---</span>
  
      static class ReflectionEvent extends Event {
          public void myCommit() throws Throwable {
              Class&lt;?&gt; c;
              try {
<span class="line-modified">!                 c = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);</span>
<span class="line-modified">!                 Method m = c.getMethod(&quot;getEventWriter&quot;, new Class[0]);</span>
                  m.invoke(null, Long.valueOf(4711)); // throws InternalError
              } catch (ClassNotFoundException | SecurityException e) {
                  throw new RuntimeException(e);
              }
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 281,11 ***</span>
              e.myCommit(); // throws
              throw new RuntimeException(&quot;Should not reach here&quot;);
          } catch (InternalError ie) {
              if (ie.getCause() instanceof IllegalAccessException iaex) {
                  if (iaex.getCause() instanceof IllegalAccessError iae) {
<span class="line-modified">!                     if (iae.getMessage().contains(&quot;getEventWriter(long)&quot;)) {</span>
                          // OK, as expected
                          return;
                      }
                  }
              }
<span class="line-new-header">--- 278,11 ---</span>
              e.myCommit(); // throws
              throw new RuntimeException(&quot;Should not reach here&quot;);
          } catch (InternalError ie) {
              if (ie.getCause() instanceof IllegalAccessException iaex) {
                  if (iaex.getCause() instanceof IllegalAccessError iae) {
<span class="line-modified">!                     if (iae.getMessage().contains(&quot;getEventWriter()&quot;)) {</span>
                          // OK, as expected
                          return;
                      }
                  }
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 343,11 ***</span>
              throw new Exception(&quot;Test error, could not located class file for &quot; + name);
          }
          byte[] bytes = is.readAllBytes();
          is.close();
          bytes = replace(bytes, &quot;jdk/jfr/jvm/E&quot;, &quot;jdk/jfr/Event&quot;);
<span class="line-removed">-         bytes = replace(bytes, &quot;jdk/jfr/jvm/PlaceholderEventWriterFactory&quot;, &quot;jdk/jfr/internal/event/EventWriterFactory&quot;);</span>
          bytes = replace(bytes, &quot;jdk/jfr/jvm/PlaceholderEventWriter&quot;, &quot;jdk/jfr/internal/event/EventWriter&quot;);
          BytesClassLoader bc = new BytesClassLoader(bytes, fullName);
          Class&lt;?&gt; clazz = bc.loadClass(fullName);
          Constructor&lt;?&gt; constructor = clazz.getConstructor(new Class[0]);
          System.out.println(&quot;About to invoke &quot; + fullName + &quot;.commit()&quot;);
<span class="line-new-header">--- 340,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 370,19 ***</span>
          }
          checkJVMCI(eventClass, commitName);
      }
  
      /**
<span class="line-modified">!      * Checks that JVMCI prevents unblessed access to {@code EventWriterFactory.getEventWriter(long)}.</span>
       */
      private static void checkJVMCI(Class&lt;?&gt; eventClass, String commitName) throws Throwable {
          MetaAccessProvider metaAccess = JVMCI.getRuntime().getHostJVMCIBackend().getMetaAccess();
          ResolvedJavaMethod commit = findCommitMethod(metaAccess, eventClass, commitName);
          ConstantPool cp = commit.getConstantPool();
  
          // Search for first INVOKESTATIC instruction in commit method which is expected
<span class="line-modified">!         // to be the call to jdk.jfr.internal.event.EventWriterFactory.getEventWriter(long).</span>
          final int INVOKESTATIC = 184;
          byte[] code = commit.getCode();
          for (int bci = 0; bci &lt; code.length; bci++) {
              int b = code[bci] &amp; 0xff;
              if (b == INVOKESTATIC) {
<span class="line-new-header">--- 366,19 ---</span>
          }
          checkJVMCI(eventClass, commitName);
      }
  
      /**
<span class="line-modified">!      * Checks that JVMCI prevents unblessed access to {@code EventWriter.getEventWriter()}.</span>
       */
      private static void checkJVMCI(Class&lt;?&gt; eventClass, String commitName) throws Throwable {
          MetaAccessProvider metaAccess = JVMCI.getRuntime().getHostJVMCIBackend().getMetaAccess();
          ResolvedJavaMethod commit = findCommitMethod(metaAccess, eventClass, commitName);
          ConstantPool cp = commit.getConstantPool();
  
          // Search for first INVOKESTATIC instruction in commit method which is expected
<span class="line-modified">!         // to be the call to jdk.jfr.internal.event.EventWriter.getEventWriter().</span>
          final int INVOKESTATIC = 184;
          byte[] code = commit.getCode();
          for (int bci = 0; bci &lt; code.length; bci++) {
              int b = code[bci] &amp; 0xff;
              if (b == INVOKESTATIC) {
</pre>
<center><a href="StaticCommitEvent.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tool/TestAssemble.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>