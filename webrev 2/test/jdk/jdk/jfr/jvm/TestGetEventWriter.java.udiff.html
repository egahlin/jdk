<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff test/jdk/jdk/jfr/jvm/TestGetEventWriter.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="StaticCommitEvent.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tool/TestAssemble.java.udiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/jdk/jfr/jvm/TestGetEventWriter.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2022, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2022, 2025, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -44,11 +44,10 @@</span>
   * @library /test/lib
   * @modules jdk.internal.vm.ci/jdk.vm.ci.meta
   *          jdk.internal.vm.ci/jdk.vm.ci.runtime
   *
   * @compile PlaceholderEventWriter.java
<span class="udiff-line-removed">-  * @compile PlaceholderEventWriterFactory.java</span>
   * @compile E.java
   * @compile NonEvent.java
   * @compile RegisteredTrueEvent.java
   * @compile RegisteredFalseEvent.java
   * @compile MyCommitRegisteredTrueEvent.java
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -78,11 +77,10 @@</span>
   * @library /test/lib
   * @modules jdk.internal.vm.ci/jdk.vm.ci.meta
   *          jdk.internal.vm.ci/jdk.vm.ci.runtime
   *
   * @compile PlaceholderEventWriter.java
<span class="udiff-line-removed">-  * @compile PlaceholderEventWriterFactory.java</span>
   * @compile E.java
   * @compile NonEvent.java
   * @compile RegisteredTrueEvent.java
   * @compile RegisteredFalseEvent.java
   * @compile MyCommitRegisteredTrueEvent.java
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -103,14 +101,14 @@</span>
              r.start();
              // Unlocks access to jdk.jfr.internal.event
              InitializationEvent e  = new InitializationEvent();
              e.commit();
          }
<span class="udiff-line-modified-removed">-         // Make sure EventWriterFactory can be accessed.</span>
<span class="udiff-line-modified-removed">-         Class&lt;?&gt; clazz = Class.forName(&quot;jdk.jfr.internal.event.EventWriterFactory&quot;);</span>
<span class="udiff-line-modified-added">+         // Make sure EventWriter class can be accessed.</span>
<span class="udiff-line-modified-added">+         Class&lt;?&gt; clazz = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);</span>
          if (clazz == null) {
<span class="udiff-line-modified-removed">-             throw new Exception(&quot;Test error, not able to access jdk.jfr.internal.event.EventWriterFactory class&quot;);</span>
<span class="udiff-line-modified-added">+             throw new Exception(&quot;Test error, not able to access jdk.jfr.internal.event.EventWriter class&quot;);</span>
          }
          testRegisteredTrueEvent();
          testRegisteredFalseEvent();
          testMyCommitRegisteredTrue();
          testMyCommitRegisteredFalse();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -120,11 +118,11 @@</span>
          testNonEvent();
      }
  
      // The class does not inherit jdk.jfr.Event and, as such, does not implement the
      // API. It has its own stand-alone &quot;commit()V&quot;, which is not an override, that
<span class="udiff-line-modified-removed">-     // attempts to resolve and link against EventWriterFactory. This user implementation</span>
<span class="udiff-line-modified-added">+     // attempts to resolve and link against EventWriter. This user implementation</span>
      // is not blessed for linkage.
      private static void testNonEvent() throws Throwable {
          Runnable e = newEventObject(&quot;NonEvent&quot;);
          try {
              e.run(); // invokes commit()
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -176,11 +174,11 @@</span>
              // methods in jdk.jfr.Event
          }
      }
  
      // The user has implemented another method, &quot;myCommit()V&quot;, not an override nor
<span class="udiff-line-modified-removed">-     // overload. that attempts to resolve and link EventWriterFactory. This will fail,</span>
<span class="udiff-line-modified-added">+     // overload. that attempts to resolve and link EventWriter. This will fail,</span>
      // because &quot;myCommit()V&quot; is not blessed for linkage.
      private static void testMyCommitRegisteredTrue() throws Throwable {
          Runnable e = newEventObject(&quot;MyCommitRegisteredTrueEvent&quot;);
          try {
              e.run(); // Invoking the user-defined method throws.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -228,14 +226,13 @@</span>
  
      static class MethodHandleEvent extends Event {
          public void myCommit() throws Throwable {
              try {
                  Class&lt;?&gt; ew = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);
<span class="udiff-line-modified-removed">-                 MethodType t = MethodType.methodType(ew, List.of(long.class));</span>
<span class="udiff-line-modified-removed">-                 Class&lt;?&gt; factory = Class.forName(&quot;jdk.jfr.internal.event.EventWriterFactory&quot;);</span>
<span class="udiff-line-modified-removed">-                 MethodHandle mh = MethodHandles.lookup().findStatic(factory, &quot;getEventWriter&quot;, t);</span>
<span class="udiff-line-removed">-                 mh.invoke(Long.valueOf(4711)); // throws IllegalAccessException</span>
<span class="udiff-line-modified-added">+                 MethodType t = MethodType.methodType(ew, List.of());</span>
<span class="udiff-line-modified-added">+                 MethodHandle mh = MethodHandles.lookup().findStatic(ew, &quot;getEventWriter&quot;, t);</span>
<span class="udiff-line-modified-added">+                 mh.invoke(); // throws IllegalAccessException</span>
              } catch (ClassNotFoundException | SecurityException e) {
                  throw new RuntimeException(e);
              }
          }
      }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -260,12 +257,12 @@</span>
  
      static class ReflectionEvent extends Event {
          public void myCommit() throws Throwable {
              Class&lt;?&gt; c;
              try {
<span class="udiff-line-modified-removed">-                 c = Class.forName(&quot;jdk.jfr.internal.event.EventWriterFactory&quot;);</span>
<span class="udiff-line-modified-removed">-                 Method m = c.getMethod(&quot;getEventWriter&quot;, new Class[] {long.class});</span>
<span class="udiff-line-modified-added">+                 c = Class.forName(&quot;jdk.jfr.internal.event.EventWriter&quot;);</span>
<span class="udiff-line-modified-added">+                 Method m = c.getMethod(&quot;getEventWriter&quot;, new Class[0]);</span>
                  m.invoke(null, Long.valueOf(4711)); // throws InternalError
              } catch (ClassNotFoundException | SecurityException e) {
                  throw new RuntimeException(e);
              }
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -281,11 +278,11 @@</span>
              e.myCommit(); // throws
              throw new RuntimeException(&quot;Should not reach here&quot;);
          } catch (InternalError ie) {
              if (ie.getCause() instanceof IllegalAccessException iaex) {
                  if (iaex.getCause() instanceof IllegalAccessError iae) {
<span class="udiff-line-modified-removed">-                     if (iae.getMessage().contains(&quot;getEventWriter(long)&quot;)) {</span>
<span class="udiff-line-modified-added">+                     if (iae.getMessage().contains(&quot;getEventWriter()&quot;)) {</span>
                          // OK, as expected
                          return;
                      }
                  }
              }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -343,11 +340,10 @@</span>
              throw new Exception(&quot;Test error, could not located class file for &quot; + name);
          }
          byte[] bytes = is.readAllBytes();
          is.close();
          bytes = replace(bytes, &quot;jdk/jfr/jvm/E&quot;, &quot;jdk/jfr/Event&quot;);
<span class="udiff-line-removed">-         bytes = replace(bytes, &quot;jdk/jfr/jvm/PlaceholderEventWriterFactory&quot;, &quot;jdk/jfr/internal/event/EventWriterFactory&quot;);</span>
          bytes = replace(bytes, &quot;jdk/jfr/jvm/PlaceholderEventWriter&quot;, &quot;jdk/jfr/internal/event/EventWriter&quot;);
          BytesClassLoader bc = new BytesClassLoader(bytes, fullName);
          Class&lt;?&gt; clazz = bc.loadClass(fullName);
          Constructor&lt;?&gt; constructor = clazz.getConstructor(new Class[0]);
          System.out.println(&quot;About to invoke &quot; + fullName + &quot;.commit()&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -370,19 +366,19 @@</span>
          }
          checkJVMCI(eventClass, commitName);
      }
  
      /**
<span class="udiff-line-modified-removed">-      * Checks that JVMCI prevents unblessed access to {@code EventWriterFactory.getEventWriter(long)}.</span>
<span class="udiff-line-modified-added">+      * Checks that JVMCI prevents unblessed access to {@code EventWriter.getEventWriter()}.</span>
       */
      private static void checkJVMCI(Class&lt;?&gt; eventClass, String commitName) throws Throwable {
          MetaAccessProvider metaAccess = JVMCI.getRuntime().getHostJVMCIBackend().getMetaAccess();
          ResolvedJavaMethod commit = findCommitMethod(metaAccess, eventClass, commitName);
          ConstantPool cp = commit.getConstantPool();
  
          // Search for first INVOKESTATIC instruction in commit method which is expected
<span class="udiff-line-modified-removed">-         // to be the call to jdk.jfr.internal.event.EventWriterFactory.getEventWriter(long).</span>
<span class="udiff-line-modified-added">+         // to be the call to jdk.jfr.internal.event.EventWriter.getEventWriter().</span>
          final int INVOKESTATIC = 184;
          byte[] code = commit.getCode();
          for (int bci = 0; bci &lt; code.length; bci++) {
              int b = code[bci] &amp; 0xff;
              if (b == INVOKESTATIC) {
</pre>
<center><a href="StaticCommitEvent.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="../tool/TestAssemble.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>