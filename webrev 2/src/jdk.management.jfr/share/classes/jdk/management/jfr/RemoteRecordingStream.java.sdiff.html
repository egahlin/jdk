<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.management.jfr/share/classes/jdk/management/jfr/RemoteRecordingStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="MBeanUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/jdk/jdk/jfr/jcmd/TestJcmdConfigure.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.management.jfr/share/classes/jdk/management/jfr/RemoteRecordingStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2020, 2024, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.management.jfr;
 27 
 28 import java.io.IOException;
 29 import java.io.RandomAccessFile;
 30 import java.nio.channels.FileChannel;
 31 import java.nio.file.Files;
 32 import java.nio.file.Path;
 33 import java.nio.file.Paths;
 34 import java.nio.file.StandardOpenOption;
<span class="line-removed"> 35 import java.security.AccessControlContext;</span>
<span class="line-removed"> 36 import java.security.AccessController;</span>
 37 import java.time.Duration;
 38 import java.time.Instant;
 39 import java.util.ArrayList;
 40 import java.util.Collections;
 41 import java.util.HashMap;
 42 import java.util.List;
 43 import java.util.Map;
 44 import java.util.Objects;
 45 import java.util.concurrent.Future;
 46 import java.util.function.Consumer;
<span class="line-removed"> 47 import java.security.AccessControlException;</span>
 48 import javax.management.JMX;
 49 import javax.management.MBeanServerConnection;
 50 import javax.management.ObjectName;
 51 
 52 import jdk.jfr.Configuration;
 53 import jdk.jfr.EventSettings;
 54 import jdk.jfr.EventType;
 55 import jdk.jfr.Recording;
 56 import jdk.jfr.RecordingState;
 57 import jdk.jfr.consumer.EventStream;
 58 import jdk.jfr.consumer.MetadataEvent;
 59 import jdk.jfr.consumer.RecordedEvent;
 60 import jdk.jfr.consumer.RecordingStream;
 61 import jdk.jfr.internal.management.EventSettingsModifier;
 62 import jdk.jfr.internal.management.ManagementSupport;
 63 import jdk.jfr.internal.management.StreamBarrier;
 64 import jdk.management.jfr.DiskRepository.DiskChunk;
 65 import jdk.jfr.internal.management.EventByteStream;
 66 
 67 /**
</pre>
<hr />
<pre>
132     static final class ChunkConsumer implements Consumer&lt;Long&gt; {
133 
134         private final DiskRepository repository;
135 
136         ChunkConsumer(DiskRepository repository) {
137             this.repository = repository;
138         }
139 
140         @Override
141         public void accept(Long endNanos) {
142             repository.onChunkComplete(endNanos);
143         }
144     }
145 
146     private static final ObjectName OBJECT_NAME = MBeanUtils.createObjectName();
147 
148     final Path path;
149     final FlightRecorderMXBean mbean;
150     final long recordingId;
151     final EventStream stream;
<span class="line-removed">152     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">153     final AccessControlContext accessControllerContext;</span>
154     final DiskRepository repository;
155     final Instant creationTime;
156     final Object lock = new Object();
157     volatile Instant startTime;
158     volatile Instant endTime;
159     volatile boolean closed;
160     // always guarded by lock
161     private boolean started;
162     private Duration maxAge;
163     private long maxSize;
164 
165     /**
166      * Creates an event stream that operates against a {@link MBeanServerConnection}
167      * that has a registered {@link FlightRecorderMXBean}.
168      * &lt;p&gt;
169      * To configure event settings, use {@link #setSettings(Map)}.
170      *
171      * @param connection the {@code MBeanServerConnection} where the
172      *                   {@code FlightRecorderMXBean} is registered, not
173      *                   {@code null}
</pre>
<hr />
<pre>
188      *
189      * @param connection the {@code MBeanServerConnection} where the
190      *                   {@code FlightRecorderMXBean} is registered, not
191      *                   {@code null}
192      *
193      * @param directory  the directory to store event data that is downloaded, not
194      *                   {@code null}
195      *
196      * @throws IOException       if a stream can&#39;t be opened, an I/O error occurs
197      *                           when trying to access the repository or the
198      *                           {@code FlightRecorderMXBean}
199      */
200     public RemoteRecordingStream(MBeanServerConnection connection, Path directory) throws IOException {
201         this(connection, directory, false);
202     }
203 
204     @SuppressWarnings(&quot;removal&quot;)
205     private RemoteRecordingStream(MBeanServerConnection connection, Path directory, boolean delete) throws IOException {
206         Objects.requireNonNull(connection, &quot;connection&quot;);
207         Objects.requireNonNull(directory, &quot;directory&quot;);
<span class="line-modified">208         accessControllerContext = AccessController.getContext();</span>
<span class="line-removed">209         // Make sure users can&#39;t implement malicious version of a Path object.</span>
<span class="line-removed">210         path = Paths.get(directory.toString());</span>
211         if (!Files.exists(path)) {
212             throw new IOException(&quot;Download directory doesn&#39;t exist&quot;);
213         }
214 
215         if (!Files.isDirectory(path)) {
216             throw new IOException(&quot;Download location must be a directory&quot;);
217         }
218         checkFileAccess(path);
219         creationTime = Instant.now();
220         mbean = createProxy(connection);
221         recordingId = createRecording();
<span class="line-modified">222         stream = ManagementSupport.newEventDirectoryStream(accessControllerContext, path, configurations(mbean));</span>
223         stream.setStartTime(Instant.MIN);
224         repository = new DiskRepository(path, delete);
225         ManagementSupport.setOnChunkCompleteHandler(stream, new ChunkConsumer(repository));
226     }
227 
228     private List&lt;Configuration&gt; configurations(FlightRecorderMXBean mbean) {
229         List&lt;ConfigurationInfo&gt; cis = mbean.getConfigurations();
230         List&lt;Configuration&gt; confs = new ArrayList&lt;&gt;(cis.size());
231         for (ConfigurationInfo ci : cis) {
232             confs.add(ManagementSupport.newConfiguration(ci.getName(), ci.getLabel(), ci.getDescription(),
233                     ci.getProvider(), ci.getSettings(), ci.getContents()));
234         }
235         return Collections.unmodifiableList(confs);
236     }
237 
238     @Override
239     public void onMetadata(Consumer&lt;MetadataEvent&gt; action) {
240         stream.onMetadata(action);
241     }
242 
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2020, 2025, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.management.jfr;
 27 
 28 import java.io.IOException;
 29 import java.io.RandomAccessFile;
 30 import java.nio.channels.FileChannel;
 31 import java.nio.file.Files;
 32 import java.nio.file.Path;
 33 import java.nio.file.Paths;
 34 import java.nio.file.StandardOpenOption;


 35 import java.time.Duration;
 36 import java.time.Instant;
 37 import java.util.ArrayList;
 38 import java.util.Collections;
 39 import java.util.HashMap;
 40 import java.util.List;
 41 import java.util.Map;
 42 import java.util.Objects;
 43 import java.util.concurrent.Future;
 44 import java.util.function.Consumer;

 45 import javax.management.JMX;
 46 import javax.management.MBeanServerConnection;
 47 import javax.management.ObjectName;
 48 
 49 import jdk.jfr.Configuration;
 50 import jdk.jfr.EventSettings;
 51 import jdk.jfr.EventType;
 52 import jdk.jfr.Recording;
 53 import jdk.jfr.RecordingState;
 54 import jdk.jfr.consumer.EventStream;
 55 import jdk.jfr.consumer.MetadataEvent;
 56 import jdk.jfr.consumer.RecordedEvent;
 57 import jdk.jfr.consumer.RecordingStream;
 58 import jdk.jfr.internal.management.EventSettingsModifier;
 59 import jdk.jfr.internal.management.ManagementSupport;
 60 import jdk.jfr.internal.management.StreamBarrier;
 61 import jdk.management.jfr.DiskRepository.DiskChunk;
 62 import jdk.jfr.internal.management.EventByteStream;
 63 
 64 /**
</pre>
<hr />
<pre>
129     static final class ChunkConsumer implements Consumer&lt;Long&gt; {
130 
131         private final DiskRepository repository;
132 
133         ChunkConsumer(DiskRepository repository) {
134             this.repository = repository;
135         }
136 
137         @Override
138         public void accept(Long endNanos) {
139             repository.onChunkComplete(endNanos);
140         }
141     }
142 
143     private static final ObjectName OBJECT_NAME = MBeanUtils.createObjectName();
144 
145     final Path path;
146     final FlightRecorderMXBean mbean;
147     final long recordingId;
148     final EventStream stream;


149     final DiskRepository repository;
150     final Instant creationTime;
151     final Object lock = new Object();
152     volatile Instant startTime;
153     volatile Instant endTime;
154     volatile boolean closed;
155     // always guarded by lock
156     private boolean started;
157     private Duration maxAge;
158     private long maxSize;
159 
160     /**
161      * Creates an event stream that operates against a {@link MBeanServerConnection}
162      * that has a registered {@link FlightRecorderMXBean}.
163      * &lt;p&gt;
164      * To configure event settings, use {@link #setSettings(Map)}.
165      *
166      * @param connection the {@code MBeanServerConnection} where the
167      *                   {@code FlightRecorderMXBean} is registered, not
168      *                   {@code null}
</pre>
<hr />
<pre>
183      *
184      * @param connection the {@code MBeanServerConnection} where the
185      *                   {@code FlightRecorderMXBean} is registered, not
186      *                   {@code null}
187      *
188      * @param directory  the directory to store event data that is downloaded, not
189      *                   {@code null}
190      *
191      * @throws IOException       if a stream can&#39;t be opened, an I/O error occurs
192      *                           when trying to access the repository or the
193      *                           {@code FlightRecorderMXBean}
194      */
195     public RemoteRecordingStream(MBeanServerConnection connection, Path directory) throws IOException {
196         this(connection, directory, false);
197     }
198 
199     @SuppressWarnings(&quot;removal&quot;)
200     private RemoteRecordingStream(MBeanServerConnection connection, Path directory, boolean delete) throws IOException {
201         Objects.requireNonNull(connection, &quot;connection&quot;);
202         Objects.requireNonNull(directory, &quot;directory&quot;);
<span class="line-modified">203         path = directory;</span>


204         if (!Files.exists(path)) {
205             throw new IOException(&quot;Download directory doesn&#39;t exist&quot;);
206         }
207 
208         if (!Files.isDirectory(path)) {
209             throw new IOException(&quot;Download location must be a directory&quot;);
210         }
211         checkFileAccess(path);
212         creationTime = Instant.now();
213         mbean = createProxy(connection);
214         recordingId = createRecording();
<span class="line-modified">215         stream = ManagementSupport.newEventDirectoryStream(path, configurations(mbean));</span>
216         stream.setStartTime(Instant.MIN);
217         repository = new DiskRepository(path, delete);
218         ManagementSupport.setOnChunkCompleteHandler(stream, new ChunkConsumer(repository));
219     }
220 
221     private List&lt;Configuration&gt; configurations(FlightRecorderMXBean mbean) {
222         List&lt;ConfigurationInfo&gt; cis = mbean.getConfigurations();
223         List&lt;Configuration&gt; confs = new ArrayList&lt;&gt;(cis.size());
224         for (ConfigurationInfo ci : cis) {
225             confs.add(ManagementSupport.newConfiguration(ci.getName(), ci.getLabel(), ci.getDescription(),
226                     ci.getProvider(), ci.getSettings(), ci.getContents()));
227         }
228         return Collections.unmodifiableList(confs);
229     }
230 
231     @Override
232     public void onMetadata(Consumer&lt;MetadataEvent&gt; action) {
233         stream.onMetadata(action);
234     }
235 
</pre>
</td>
</tr>
</table>
<center><a href="MBeanUtils.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="../../../../../../../test/jdk/jdk/jfr/jcmd/TestJcmdConfigure.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>