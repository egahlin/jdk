<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.jfr/share/classes/jdk/jfr/internal/jfc/model/JFCModel.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2021, 2022, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 package jdk.jfr.internal.jfc.model;
 26 
 27 import java.io.IOException;
 28 import java.io.PrintWriter;
 29 import java.io.Reader;
<a name="2" id="anc2"></a>
 30 import java.text.ParseException;
 31 import java.util.ArrayList;
 32 import java.util.Collections;
 33 import java.util.LinkedHashMap;
 34 import java.util.List;
 35 import java.util.Map;
 36 import java.util.function.Consumer;
 37 
<a name="3" id="anc3"></a><span class="line-removed"> 38 import jdk.jfr.internal.SecuritySupport.SafePath;</span>
 39 import jdk.jfr.internal.jfc.JFC;
 40 
 41 import static java.nio.charset.StandardCharsets.UTF_8;
 42 
 43 // Holds the structure of a .jfc file similar to an XML DOM.
 44 public final class JFCModel {
 45     private final Map&lt;String, List&lt;ControlElement&gt;&gt; controls = new LinkedHashMap&lt;&gt;();
 46     private final XmlConfiguration configuration;
 47     private final Consumer&lt;String&gt; logger;
 48 
 49     private JFCModel(XmlConfiguration configuration) throws JFCModelException {
 50         configuration.validate();
 51         this.configuration = configuration;
 52         this.logger = x -&gt; { }; // Nothing to log.
 53     }
 54 
 55     public JFCModel(Reader reader,  Consumer&lt;String&gt; logger) throws IOException, JFCModelException, ParseException {
 56         this(Parser.parse(reader));
 57         addControls();
 58         wireConditions();
 59         wireSettings(logger);
 60     }
 61 
 62     public JFCModel(Consumer&lt;String&gt; logger) {
 63         this.configuration = new XmlConfiguration();
 64         this.configuration.setAttribute(&quot;version&quot;, &quot;2.0&quot;);
 65         this.logger = logger;
 66     }
 67 
<a name="4" id="anc4"></a><span class="line-modified"> 68     public void parse(SafePath file) throws IOException, JFCModelException, ParseException {</span>
 69         JFCModel model = JFCModel.create(file, logger);
 70         for (var entry : model.controls.entrySet()) {
 71             String name = entry.getKey();
 72             // Fail-fast checks that prevents an ambiguous file to be written later
 73             if (controls.containsKey(name)) {
 74                 throw new JFCModelException(&quot;Control with &#39;&quot; + name + &quot;&#39; is declared in multiple files&quot;);
 75             }
 76             controls.put(name, entry.getValue());
 77         }
 78         for (XmlElement child : model.configuration.getChildren()) {
 79             this.configuration.addChild(child);
 80         }
 81     }
 82 
<a name="5" id="anc5"></a><span class="line-modified"> 83     public static JFCModel create(SafePath file, Consumer&lt;String&gt; logger) throws IOException, JFCModelException, ParseException{</span>
 84         if (file.toString().equals(&quot;none&quot;)) {
 85             XmlConfiguration configuration = new XmlConfiguration();
 86             configuration.setAttribute(&quot;version&quot;, &quot;2.0&quot;);
 87             configuration.setAttribute(&quot;label&quot;, &quot;None&quot;);
 88             return new JFCModel(configuration);
 89         }
 90         try (Reader r = JFC.newReader(file)) {
 91             return new JFCModel(r, logger);
 92         }
 93     }
 94 
 95     public void setLabel(String label) {
 96         configuration.setAttribute(&quot;label&quot;, label);
 97     }
 98 
 99     public void configure(String name, String value) {
100         for (XmlInput i : getInputs()) {
101             if (i.getName().equals(name)) {
102                 i.configure(value);
103                 return;
104             }
105         }
106         boolean add = name.startsWith(&quot;+&quot;);
107         if (add) {
108             name = name.substring(1);
109         }
110         int index = name.indexOf(&quot;#&quot;);
111         if (index &lt; 1 || index == name.length() - 1) {
112             throw new IllegalArgumentException(&quot;Option &#39;&quot; + name + &quot;&#39; doesn&#39;t exist in configuration&quot;);
113         }
114         XmlEvent event = configuration.getEvent(name.substring(0, index), add);
115         String settingName = name.substring(index + 1);
116         XmlSetting setting = event.getSetting(settingName, add);
117 
118         if (settingName.equals(&quot;period&quot;) || settingName.equals(&quot;threshold&quot;)) {
119             try {
120                 value = Utilities.parseTimespan(value);
121             } catch (IllegalArgumentException iae) {
122                 // OK, no validation to allow forward compatibility.
123             }
124         }
125 
126         setting.setContent(value);
127     }
128 
129     public void configure(UserInterface ui) throws AbortException {
130         for (XmlInput input : getInputs()) {
131             input.configure(ui);
132         }
133     }
134 
135     public List&lt;XmlInput&gt; getInputs() {
136         List&lt;XmlInput&gt; inputs = new ArrayList&lt;&gt;();
137         for (XmlControl control : configuration.getControls()) {
138             inputs.addAll(control.getInputs());
139         }
140         return inputs;
141     }
142 
143     public XmlConfiguration getConfiguration() {
144         return configuration;
145     }
146 
147     public LinkedHashMap&lt;String, String&gt; getSettings() {
148         LinkedHashMap&lt;String, String&gt; result = new LinkedHashMap&lt;&gt;();
149         for (XmlEvent event : configuration.getEvents()) {
150             for (XmlSetting setting : event.getSettings()) {
151                 result.put(event.getName() + &quot;#&quot; + setting.getName(), setting.getContent());
152             }
153         }
154         return result;
155     }
156 
<a name="6" id="anc6"></a><span class="line-modified">157     public void saveToFile(SafePath path) throws IOException {</span>
158         try (PrintWriter p = new PrintWriter(path.toFile(), UTF_8)) {
159             PrettyPrinter pp = new PrettyPrinter(p);
160             pp.print(configuration);
161             if (p.checkError()) {
162                 throw new IOException(&quot;Error writing &quot; + path);
163             }
164         }
165     }
166 
167     private List&lt;ControlElement&gt; getControlElements(String name) {
168         return controls.getOrDefault(name, Collections.emptyList());
169     }
170 
171     private void addControls() {
172         for (var controls : configuration.getControls()) {
173             for (var control : controls.getControlElements()) {
174                 add(control);
175             }
176         }
177     }
178 
179     private void wireConditions() {
180         for (XmlControl control : configuration.getControls()) {
181             for (XmlCondition condition : control.getConditions()) {
182                 for (XmlElement element : condition.getChildren()) {
183                     wireExpression(condition, element);
184                 }
185             }
186         }
187     }
188 
189     private void wireExpression(XmlElement parent, XmlElement element) {
190         element.addListener(parent);
191         if (element instanceof XmlTest test) {
192             wireTest(test);
193         }
194         if (element instanceof XmlExpression expression) {
195             for (XmlExpression child : expression.getExpressions()) {
196                 wireExpression(expression, child);
197             }
198         }
199     }
200 
201     private void wireTest(XmlTest test) {
202         String name = test.getName();
203         for (ControlElement ce : getControlElements(name)) {
204             XmlElement control = (XmlElement) ce;
205             control.addListener(test);
206         }
207     }
208 
209     private void wireSettings(Consumer&lt;String&gt; logger) {
210         for (XmlEvent event : configuration.getEvents()) {
211             for (XmlSetting setting : event.getSettings()) {
212                 var controlName = setting.getControl();
213                 if (controlName.isPresent()) {
214                     List&lt;ControlElement&gt; controls = getControlElements(controlName.get());
215                     if (controls.isEmpty()) {
216                         logger.accept(&quot;Setting &#39;&quot; + setting.getFullName() + &quot;&#39; refers to missing control &#39;&quot; + controlName.get() + &quot;&#39;&quot;);
217                     }
218                     for (ControlElement ce : controls) {
219                         XmlElement control = (XmlElement) ce;
220                         control.addListener(setting);
221                     }
222                 }
223             }
224         }
225     }
226 
227     private void add(ControlElement control) {
228         controls.computeIfAbsent(control.getName(), x -&gt; new ArrayList&lt;&gt;()).add(control);
229     }
230 }
<a name="7" id="anc7"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="7" type="hidden" />
</body>
</html>