<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.jfr/share/classes/jdk/jfr/internal/RepositoryChunk.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="Repository.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SecuritySupport.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/RepositoryChunk.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2024, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2012, 2025, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 25,42 ***</span>
  
  package jdk.jfr.internal;
  
  import java.io.IOException;
  import java.io.RandomAccessFile;
  import java.nio.channels.ReadableByteChannel;
  import java.time.Instant;
  import java.util.Comparator;
  
<span class="line-removed">- import jdk.jfr.internal.SecuritySupport.SafePath;</span>
<span class="line-removed">- </span>
  public final class RepositoryChunk {
  
      static final Comparator&lt;RepositoryChunk&gt; END_TIME_COMPARATOR = new Comparator&lt;RepositoryChunk&gt;() {
          @Override
          public int compare(RepositoryChunk c1, RepositoryChunk c2) {
              return c1.endTime.compareTo(c2.endTime);
          }
      };
  
<span class="line-modified">!     private final SafePath chunkFile;</span>
      private final RandomAccessFile unFinishedRAF;
  
      private Instant endTime = null; // unfinished
      private Instant startTime;
      private int refCount = 1;
      private long size;
  
<span class="line-modified">!     RepositoryChunk(SafePath path) throws Exception {</span>
          this.chunkFile = path;
<span class="line-modified">!         this.unFinishedRAF = SecuritySupport.createRandomAccessFile(chunkFile);</span>
      }
  
      boolean finish(Instant endTime) {
          try {
              unFinishedRAF.close();
<span class="line-modified">!             size = SecuritySupport.getFileSize(chunkFile);</span>
              this.endTime = endTime;
              if (Logger.shouldLog(LogTag.JFR_SYSTEM, LogLevel.DEBUG)) {
                  Logger.log(LogTag.JFR_SYSTEM, LogLevel.DEBUG, &quot;Chunk finished: &quot; + chunkFile);
              }
              return true;
<span class="line-new-header">--- 25,44 ---</span>
  
  package jdk.jfr.internal;
  
  import java.io.IOException;
  import java.io.RandomAccessFile;
<span class="line-added">+ import java.nio.channels.FileChannel;</span>
  import java.nio.channels.ReadableByteChannel;
<span class="line-added">+ import java.nio.file.Files;</span>
<span class="line-added">+ import java.nio.file.Path;</span>
<span class="line-added">+ import java.nio.file.StandardOpenOption;</span>
  import java.time.Instant;
  import java.util.Comparator;
  
  public final class RepositoryChunk {
  
      static final Comparator&lt;RepositoryChunk&gt; END_TIME_COMPARATOR = new Comparator&lt;RepositoryChunk&gt;() {
          @Override
          public int compare(RepositoryChunk c1, RepositoryChunk c2) {
              return c1.endTime.compareTo(c2.endTime);
          }
      };
  
<span class="line-modified">!     private final Path chunkFile;</span>
      private final RandomAccessFile unFinishedRAF;
  
      private Instant endTime = null; // unfinished
      private Instant startTime;
      private int refCount = 1;
      private long size;
  
<span class="line-modified">!     RepositoryChunk(Path path) throws Exception {</span>
          this.chunkFile = path;
<span class="line-modified">!         this.unFinishedRAF = new RandomAccessFile(path.toFile(), &quot;rw&quot;);</span>
      }
  
      boolean finish(Instant endTime) {
          try {
              unFinishedRAF.close();
<span class="line-modified">!             size = Files.size(chunkFile);</span>
              this.endTime = endTime;
              if (Logger.shouldLog(LogTag.JFR_SYSTEM, LogLevel.DEBUG)) {
                  Logger.log(LogTag.JFR_SYSTEM, LogLevel.DEBUG, &quot;Chunk finished: &quot; + chunkFile);
              }
              return true;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 87,13 ***</span>
  
      public Instant getEndTime() {
          return endTime;
      }
  
<span class="line-modified">!     private void delete(SafePath f) {</span>
          try {
<span class="line-modified">!             SecuritySupport.delete(f);</span>
              if (Logger.shouldLog(LogTag.JFR, LogLevel.DEBUG)) {
                  Logger.log(LogTag.JFR, LogLevel.DEBUG, &quot;Repository chunk &quot; + f + &quot; deleted&quot;);
              }
          } catch (IOException e) {
              // Probably happens because file is being streamed
<span class="line-new-header">--- 89,13 ---</span>
  
      public Instant getEndTime() {
          return endTime;
      }
  
<span class="line-modified">!     private void delete(Path f) {</span>
          try {
<span class="line-modified">!             Files.delete(f);</span>
              if (Logger.shouldLog(LogTag.JFR, LogLevel.DEBUG)) {
                  Logger.log(LogTag.JFR, LogLevel.DEBUG, &quot;Repository chunk &quot; + f + &quot; deleted&quot;);
              }
          } catch (IOException e) {
              // Probably happens because file is being streamed
</pre>
<hr />
<pre>
<span class="line-old-header">*** 151,11 ***</span>
  
      ReadableByteChannel newChannel() throws IOException {
          if (!isFinished()) {
              throw new IOException(&quot;Chunk not finished&quot;);
          }
<span class="line-modified">!         return ((SecuritySupport.newFileChannelToRead(chunkFile)));</span>
      }
  
      public boolean inInterval(Instant startTime, Instant endTime) {
          if (startTime != null &amp;&amp; getEndTime().isBefore(startTime)) {
              return false;
<span class="line-new-header">--- 153,11 ---</span>
  
      ReadableByteChannel newChannel() throws IOException {
          if (!isFinished()) {
              throw new IOException(&quot;Chunk not finished&quot;);
          }
<span class="line-modified">!         return FileChannel.open(chunkFile, StandardOpenOption.READ);</span>
      }
  
      public boolean inInterval(Instant startTime, Instant endTime) {
          if (startTime != null &amp;&amp; getEndTime().isBefore(startTime)) {
              return false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 164,25 ***</span>
              return false;
          }
          return true;
      }
  
<span class="line-modified">!     public SafePath getFile() {</span>
          return chunkFile;
      }
  
      public long getCurrentFileSize() {
          try {
<span class="line-modified">!             return SecuritySupport.getFileSize(chunkFile);</span>
          } catch (IOException e) {
              return 0L;
          }
      }
  
      boolean isMissingFile() {
<span class="line-modified">!         try {</span>
<span class="line-removed">-             return !SecuritySupport.exists(chunkFile);</span>
<span class="line-removed">-         } catch (IOException ioe) {</span>
<span class="line-removed">-             return true;</span>
<span class="line-removed">-         }</span>
      }
  }
<span class="line-new-header">--- 166,21 ---</span>
              return false;
          }
          return true;
      }
  
<span class="line-modified">!     public Path getFile() {</span>
          return chunkFile;
      }
  
      public long getCurrentFileSize() {
          try {
<span class="line-modified">!             return Files.size(chunkFile);</span>
          } catch (IOException e) {
              return 0L;
          }
      }
  
      boolean isMissingFile() {
<span class="line-modified">!         return !Files.exists(chunkFile);</span>
      }
  }
</pre>
<center><a href="Repository.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="SecuritySupport.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>