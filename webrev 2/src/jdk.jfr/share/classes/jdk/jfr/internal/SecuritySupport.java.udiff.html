<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff src/jdk.jfr/share/classes/jdk/jfr/internal/SecuritySupport.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="RepositoryChunk.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ShutdownHook.java.udiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/SecuritySupport.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -1,7 +1,7 @@</span>
  /*
<span class="udiff-line-modified-removed">-  * Copyright (c) 2016, 2024, Oracle and/or its affiliates. All rights reserved.</span>
<span class="udiff-line-modified-added">+  * Copyright (c) 2016, 2025, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -23,284 +23,25 @@</span>
   * questions.
   */
  
  package jdk.jfr.internal;
  
<span class="udiff-line-removed">- import java.io.File;</span>
<span class="udiff-line-removed">- import java.io.FileNotFoundException;</span>
<span class="udiff-line-removed">- import java.io.IOException;</span>
<span class="udiff-line-removed">- import java.io.InputStream;</span>
<span class="udiff-line-removed">- import java.io.RandomAccessFile;</span>
<span class="udiff-line-removed">- import java.io.Reader;</span>
  import java.lang.invoke.MethodHandles;
<span class="udiff-line-removed">- import java.lang.reflect.Constructor;</span>
<span class="udiff-line-removed">- import java.lang.reflect.Method;</span>
<span class="udiff-line-removed">- import java.lang.reflect.ReflectPermission;</span>
<span class="udiff-line-removed">- import java.nio.channels.FileChannel;</span>
<span class="udiff-line-removed">- import java.nio.channels.ReadableByteChannel;</span>
<span class="udiff-line-removed">- import java.nio.file.DirectoryStream;</span>
<span class="udiff-line-removed">- import java.nio.file.FileVisitResult;</span>
<span class="udiff-line-removed">- import java.nio.file.Files;</span>
<span class="udiff-line-removed">- import java.nio.file.LinkOption;</span>
<span class="udiff-line-removed">- import java.nio.file.Path;</span>
<span class="udiff-line-removed">- import java.nio.file.Paths;</span>
<span class="udiff-line-removed">- import java.nio.file.SimpleFileVisitor;</span>
<span class="udiff-line-removed">- import java.nio.file.StandardOpenOption;</span>
<span class="udiff-line-removed">- import java.nio.file.attribute.BasicFileAttributes;</span>
<span class="udiff-line-removed">- import java.nio.file.attribute.FileTime;</span>
<span class="udiff-line-removed">- import java.security.AccessControlContext;</span>
<span class="udiff-line-removed">- import java.security.AccessController;</span>
<span class="udiff-line-removed">- import java.security.Permission;</span>
<span class="udiff-line-removed">- import java.security.PrivilegedAction;</span>
<span class="udiff-line-removed">- import java.security.PrivilegedActionException;</span>
<span class="udiff-line-removed">- import java.security.PrivilegedExceptionAction;</span>
<span class="udiff-line-removed">- import java.util.ArrayList;</span>
<span class="udiff-line-removed">- import java.util.List;</span>
<span class="udiff-line-removed">- import java.util.Objects;</span>
<span class="udiff-line-removed">- import java.util.PropertyPermission;</span>
<span class="udiff-line-removed">- import java.util.concurrent.Callable;</span>
<span class="udiff-line-removed">- </span>
  import jdk.internal.module.Modules;
  import jdk.jfr.Event;
<span class="udiff-line-removed">- import jdk.jfr.FlightRecorder;</span>
<span class="udiff-line-removed">- import jdk.jfr.FlightRecorderListener;</span>
<span class="udiff-line-removed">- import jdk.jfr.FlightRecorderPermission;</span>
<span class="udiff-line-removed">- import jdk.jfr.Recording;</span>
<span class="udiff-line-removed">- import jdk.jfr.internal.consumer.FileAccess;</span>
  
<span class="udiff-line-removed">- /**</span>
<span class="udiff-line-removed">-  * Contains JFR code that does</span>
<span class="udiff-line-removed">-  * {@link AccessController#doPrivileged(PrivilegedAction)}</span>
<span class="udiff-line-removed">-  */</span>
  public final class SecuritySupport {
<span class="udiff-line-removed">-     private static final String EVENTS_PACKAGE_NAME = &quot;jdk.jfr.events&quot;;</span>
<span class="udiff-line-removed">-     private static final String EVENT_PACKAGE_NAME = &quot;jdk.jfr.internal.event&quot;;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static final String REGISTER_EVENT = &quot;registerEvent&quot;;</span>
<span class="udiff-line-removed">-     public static final String ACCESS_FLIGHT_RECORDER = &quot;accessFlightRecorder&quot;;</span>
<span class="udiff-line-removed">-     private static final MethodHandles.Lookup LOOKUP = MethodHandles.lookup();</span>
      private static final Module JFR_MODULE = Event.class.getModule();
<span class="udiff-line-modified-removed">-     public  static final SafePath JFC_DIRECTORY = getPathInProperty(&quot;java.home&quot;, &quot;lib/jfr&quot;);</span>
<span class="udiff-line-removed">-     public static final FileAccess PRIVILEGED = new Privileged();</span>
<span class="udiff-line-removed">-     static final SafePath JAVA_IO_TMPDIR = getPathInProperty(&quot;java.io.tmpdir&quot;, null);</span>
<span class="udiff-line-modified-added">+     private static final MethodHandles.Lookup LOOKUP = MethodHandles.lookup();</span>
  
      static {
          // ensure module java.base can read module jdk.jfr as early as possible
          addReadEdge(Object.class);
          addInternalEventExport(Object.class);
          addEventsExport(Object.class);
      }
  
<span class="udiff-line-removed">-     static final class SecureRecorderListener implements FlightRecorderListener {</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-         private final AccessControlContext context;</span>
<span class="udiff-line-removed">-         private final FlightRecorderListener changeListener;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         SecureRecorderListener(@SuppressWarnings(&quot;removal&quot;) AccessControlContext context, FlightRecorderListener changeListener) {</span>
<span class="udiff-line-removed">-             this.context = Objects.requireNonNull(context);</span>
<span class="udiff-line-removed">-             this.changeListener = Objects.requireNonNull(changeListener);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public void recordingStateChanged(Recording recording) {</span>
<span class="udiff-line-removed">-             AccessController.doPrivileged((PrivilegedAction&lt;Void&gt;) () -&gt; {</span>
<span class="udiff-line-removed">-                 try {</span>
<span class="udiff-line-removed">-                     changeListener.recordingStateChanged(recording);</span>
<span class="udiff-line-removed">-                 } catch (Throwable t) {</span>
<span class="udiff-line-removed">-                     // Prevent malicious user to propagate exception callback in the wrong context</span>
<span class="udiff-line-removed">-                     Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Unexpected exception in listener &quot; + changeListener.getClass()+ &quot; at recording state change&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }, context);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public void recorderInitialized(FlightRecorder recorder) {</span>
<span class="udiff-line-removed">-             AccessController.doPrivileged((PrivilegedAction&lt;Void&gt;) () -&gt; {</span>
<span class="udiff-line-removed">-                 try  {</span>
<span class="udiff-line-removed">-                     changeListener.recorderInitialized(recorder);</span>
<span class="udiff-line-removed">-                 } catch (Throwable t) {</span>
<span class="udiff-line-removed">-                     // Prevent malicious user to propagate exception callback in the wrong context</span>
<span class="udiff-line-removed">-                     Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Unexpected exception in listener &quot; + changeListener.getClass()+ &quot; when initializing FlightRecorder&quot;);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }, context);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         public FlightRecorderListener getChangeListener() {</span>
<span class="udiff-line-removed">-             return changeListener;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static final class DirectoryCleaner extends SimpleFileVisitor&lt;Path&gt; {</span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public FileVisitResult visitFile(Path path, BasicFileAttributes attrs) throws IOException {</span>
<span class="udiff-line-removed">-             Files.delete(path);</span>
<span class="udiff-line-removed">-             return FileVisitResult.CONTINUE;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public FileVisitResult postVisitDirectory(Path dir, IOException exc) throws IOException {</span>
<span class="udiff-line-removed">-             if (exc != null) {</span>
<span class="udiff-line-removed">-                 throw exc;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             Files.delete(dir);</span>
<span class="udiff-line-removed">-             return FileVisitResult.CONTINUE;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     /**</span>
<span class="udiff-line-removed">-      * Path created by the default file provider, and not</span>
<span class="udiff-line-removed">-      * a malicious provider.</span>
<span class="udiff-line-removed">-      *</span>
<span class="udiff-line-removed">-      */</span>
<span class="udiff-line-removed">-     public static final class SafePath implements Comparable&lt;SafePath&gt; {</span>
<span class="udiff-line-removed">-         private final Path path;</span>
<span class="udiff-line-removed">-         private final String text;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         public SafePath(Path p) {</span>
<span class="udiff-line-removed">-             // sanitize</span>
<span class="udiff-line-removed">-             text = p.toString();</span>
<span class="udiff-line-removed">-             path = Paths.get(text);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         public SafePath(String path) {</span>
<span class="udiff-line-removed">-             this(Paths.get(path));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         public Path toPath() {</span>
<span class="udiff-line-removed">-             return path;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         public File toFile() {</span>
<span class="udiff-line-removed">-             return path.toFile();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public String toString() {</span>
<span class="udiff-line-removed">-             return text;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public int compareTo(SafePath that) {</span>
<span class="udiff-line-removed">-             return that.text.compareTo(this.text);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public boolean equals(Object other) {</span>
<span class="udiff-line-removed">-             if(other != null &amp;&amp; other instanceof SafePath s){</span>
<span class="udiff-line-removed">-                 return this.toPath().equals(s.toPath());</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             return false;</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public int hashCode() {</span>
<span class="udiff-line-removed">-             return this.toPath().hashCode();</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private interface RunnableWithCheckedException {</span>
<span class="udiff-line-removed">-         public void run() throws Exception;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private interface CallableWithoutCheckException&lt;T&gt; {</span>
<span class="udiff-line-removed">-         public T call();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static void checkAccessFlightRecorder() throws SecurityException {</span>
<span class="udiff-line-removed">-         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-         SecurityManager sm = System.getSecurityManager();</span>
<span class="udiff-line-removed">-         if (sm != null) {</span>
<span class="udiff-line-removed">-             sm.checkPermission(new FlightRecorderPermission(ACCESS_FLIGHT_RECORDER));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static void checkRegisterPermission() throws SecurityException {</span>
<span class="udiff-line-removed">-         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-         SecurityManager sm = System.getSecurityManager();</span>
<span class="udiff-line-removed">-         if (sm != null) {</span>
<span class="udiff-line-removed">-             sm.checkPermission(new FlightRecorderPermission(REGISTER_EVENT));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-     private static &lt;U&gt; U doPrivilegedIOWithReturn(Callable&lt;U&gt; function) throws IOException {</span>
<span class="udiff-line-removed">-         try {</span>
<span class="udiff-line-removed">-             return AccessController.doPrivileged(new PrivilegedExceptionAction&lt;U&gt;() {</span>
<span class="udiff-line-removed">-                 @Override</span>
<span class="udiff-line-removed">-                 public U run() throws Exception {</span>
<span class="udiff-line-removed">-                     return function.call();</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }, null);</span>
<span class="udiff-line-removed">-         } catch (PrivilegedActionException e) {</span>
<span class="udiff-line-removed">-             Throwable t = e.getCause();</span>
<span class="udiff-line-removed">-             if (t instanceof IOException) {</span>
<span class="udiff-line-removed">-                 throw (IOException) t;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             throw new IOException(&quot;Unexpected error during I/O operation. &quot; + t.getMessage(), t);</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static void doPriviligedIO(RunnableWithCheckedException function) throws IOException {</span>
<span class="udiff-line-removed">-         doPrivilegedIOWithReturn(() -&gt; {</span>
<span class="udiff-line-removed">-             function.run();</span>
<span class="udiff-line-removed">-             return null;</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-     private static void doPrivileged(Runnable function, Permission... perms) {</span>
<span class="udiff-line-removed">-         AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
<span class="udiff-line-removed">-             @Override</span>
<span class="udiff-line-removed">-             public Void run() {</span>
<span class="udiff-line-removed">-                 function.run();</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }, null, perms);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-     private static void doPrivileged(Runnable function) {</span>
<span class="udiff-line-removed">-         AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
<span class="udiff-line-removed">-             @Override</span>
<span class="udiff-line-removed">-             public Void run() {</span>
<span class="udiff-line-removed">-                 function.run();</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="udiff-line-removed">-     private static &lt;T&gt; T doPrivilegedWithReturn(CallableWithoutCheckException&lt;T&gt; function, Permission... perms) {</span>
<span class="udiff-line-removed">-         return AccessController.doPrivileged(new PrivilegedAction&lt;T&gt;() {</span>
<span class="udiff-line-removed">-             @Override</span>
<span class="udiff-line-removed">-             public T run() {</span>
<span class="udiff-line-removed">-                 return function.call();</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         }, null, perms);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static List&lt;SafePath&gt; getPredefinedJFCFiles() {</span>
<span class="udiff-line-removed">-         List&lt;SafePath&gt; list = new ArrayList&lt;&gt;();</span>
<span class="udiff-line-removed">-         try (var ds = doPrivilegedIOWithReturn(() -&gt; Files.newDirectoryStream(JFC_DIRECTORY.toPath()))) {</span>
<span class="udiff-line-removed">-             for (Path path : ds) {</span>
<span class="udiff-line-removed">-                 SafePath s = new SafePath(path);</span>
<span class="udiff-line-removed">-                 String text = s.toString();</span>
<span class="udiff-line-removed">-                 if (text.endsWith(&quot;.jfc&quot;) &amp;&amp; !SecuritySupport.isDirectory(s)) {</span>
<span class="udiff-line-removed">-                     list.add(s);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         } catch (IOException ioe) {</span>
<span class="udiff-line-removed">-             Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Could not access .jfc-files in &quot; + JFC_DIRECTORY + &quot;, &quot; + ioe.getMessage());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         return list;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      static void makeVisibleToJFR(Class&lt;?&gt; clazz) {
          Module classModule = clazz.getModule();
          Modules.addReads(JFR_MODULE, classModule);
          if (clazz.getPackage() != null) {
              String packageName = clazz.getPackage().getName();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -312,215 +53,33 @@</span>
      /**
       * Adds a qualified export of the internal.jdk.jfr.internal.event package
       * (for EventConfiguration and EventWriter)
       */
      static void addInternalEventExport(Class&lt;?&gt; clazz) {
<span class="udiff-line-modified-removed">-         Modules.addExports(JFR_MODULE, EVENT_PACKAGE_NAME, clazz.getModule());</span>
<span class="udiff-line-modified-added">+         Modules.addExports(JFR_MODULE, &quot;jdk.jfr.internal.event&quot;, clazz.getModule());</span>
      }
  
      static void addEventsExport(Class&lt;?&gt; clazz) {
<span class="udiff-line-modified-removed">-         Modules.addExports(JFR_MODULE, EVENTS_PACKAGE_NAME, clazz.getModule());</span>
<span class="udiff-line-modified-added">+         Modules.addExports(JFR_MODULE, &quot;jdk.jfr.events&quot;, clazz.getModule());</span>
      }
  
      static void addReadEdge(Class&lt;?&gt; clazz) {
          Modules.addReads(clazz.getModule(), JFR_MODULE);
      }
  
<span class="udiff-line-removed">-     public static void registerEvent(Class&lt;? extends jdk.internal.event.Event&gt; eventClass) {</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt;  MetadataRepository.getInstance().register(eventClass), new FlightRecorderPermission(REGISTER_EVENT));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static void setProperty(String propertyName, String value) {</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt; System.setProperty(propertyName, value), new PropertyPermission(propertyName, &quot;write&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static boolean getBooleanProperty(String propertyName) {</span>
<span class="udiff-line-removed">-         return doPrivilegedWithReturn(() -&gt; Boolean.getBoolean(propertyName), new PropertyPermission(propertyName, &quot;read&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static SafePath getPathInProperty(String prop, String subPath) {</span>
<span class="udiff-line-removed">-         return doPrivilegedWithReturn(() -&gt; {</span>
<span class="udiff-line-removed">-             String path = System.getProperty(prop);</span>
<span class="udiff-line-removed">-             if (path == null) {</span>
<span class="udiff-line-removed">-                 return null;</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-             File file = subPath == null ? new File(path) : new File(path, subPath);</span>
<span class="udiff-line-removed">-             return new SafePath(file.getAbsolutePath());</span>
<span class="udiff-line-removed">-         }, new PropertyPermission(&quot;*&quot;, &quot;read&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // Called by JVM during initialization of JFR</span>
<span class="udiff-line-removed">-     static Thread createRecorderThread(ThreadGroup systemThreadGroup, ClassLoader contextClassLoader) {</span>
<span class="udiff-line-removed">-         // The thread should have permission = new Permission[0], and not &quot;modifyThreadGroup&quot; and &quot;modifyThread&quot; on the stack,</span>
<span class="udiff-line-removed">-         // but it&#39;s hard circumvent if we are going to pass in system thread group in the constructor</span>
<span class="udiff-line-removed">-         Thread thread = doPrivilegedWithReturn(() -&gt; new Thread(systemThreadGroup, &quot;JFR Recorder Thread&quot;), new RuntimePermission(&quot;modifyThreadGroup&quot;), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt; thread.setContextClassLoader(contextClassLoader), new RuntimePermission(&quot;setContextClassLoader&quot;), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="udiff-line-removed">-         return thread;</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static void registerShutdownHook(Thread shutdownHook) {</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt; Runtime.getRuntime().addShutdownHook(shutdownHook), new RuntimePermission(&quot;shutdownHooks&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static void setUncaughtExceptionHandler(Thread thread, Thread.UncaughtExceptionHandler eh) {</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt; thread.setUncaughtExceptionHandler(eh), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static void clearDirectory(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         doPriviligedIO(() -&gt; Files.walkFileTree(safePath.toPath(), new DirectoryCleaner()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static SafePath toRealPath(SafePath safePath, LinkOption... options) throws IOException {</span>
<span class="udiff-line-removed">-         return new SafePath(doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toRealPath(options)));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static boolean existDirectory(SafePath directory) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; Files.exists(directory.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static RandomAccessFile createRandomAccessFile(SafePath path) throws Exception {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; new RandomAccessFile(path.toPath().toFile(), &quot;rw&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static InputStream newFileInputStream(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; Files.newInputStream(safePath.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static long getFileSize(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; Files.size(safePath.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static SafePath createDirectories(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         Path p = doPrivilegedIOWithReturn(() -&gt; Files.createDirectories(safePath.toPath()));</span>
<span class="udiff-line-removed">-         return new SafePath(p);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static boolean exists(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         // Files.exist(path) is allocation intensive</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toFile().exists());</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static boolean isDirectory(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; Files.isDirectory(safePath.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static void delete(SafePath localPath) throws IOException {</span>
<span class="udiff-line-removed">-         doPriviligedIO(() -&gt; Files.delete(localPath.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static boolean isWritable(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; Files.isWritable(safePath.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static ReadableByteChannel newFileChannelToRead(SafePath safePath) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; FileChannel.open(safePath.toPath(), StandardOpenOption.READ));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static InputStream getResourceAsStream(String name) throws IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; SecuritySupport.class.getResourceAsStream(name));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static Reader newFileReader(SafePath safePath) throws FileNotFoundException, IOException {</span>
<span class="udiff-line-removed">-         return doPrivilegedIOWithReturn(() -&gt; Files.newBufferedReader(safePath.toPath()));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static void setAccessible(Method method) {</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt; method.setAccessible(true), new ReflectPermission(&quot;suppressAccessChecks&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     static void setAccessible(Constructor&lt;?&gt; constructor) {</span>
<span class="udiff-line-removed">-         doPrivileged(() -&gt; constructor.setAccessible(true), new ReflectPermission(&quot;suppressAccessChecks&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;removal&quot;)</span>
      public static void ensureClassIsInitialized(Class&lt;?&gt; clazz) {
          try {
<span class="udiff-line-modified-removed">-             MethodHandles.Lookup lookup;</span>
<span class="udiff-line-removed">-             if (System.getSecurityManager() == null) {</span>
<span class="udiff-line-removed">-                 lookup = MethodHandles.privateLookupIn(clazz, LOOKUP);</span>
<span class="udiff-line-removed">-             } else {</span>
<span class="udiff-line-removed">-                 lookup = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;&gt;() {</span>
<span class="udiff-line-removed">-                     @Override</span>
<span class="udiff-line-removed">-                     public MethodHandles.Lookup run() throws IllegalAccessException {</span>
<span class="udiff-line-removed">-                         return MethodHandles.privateLookupIn(clazz, LOOKUP);</span>
<span class="udiff-line-removed">-                     }</span>
<span class="udiff-line-removed">-                 }, null, new ReflectPermission(&quot;suppressAccessChecks&quot;));</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-modified-added">+             MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(clazz, LOOKUP);</span>
              lookup.ensureInitialized(clazz);
          } catch (IllegalAccessException e) {
              throw new InternalError(e);
<span class="udiff-line-removed">-         } catch (PrivilegedActionException e) {</span>
<span class="udiff-line-removed">-             throw new InternalError(e.getCause());</span>
          }
      }
  
<span class="udiff-line-removed">-     @SuppressWarnings(&quot;removal&quot;)</span>
      static Class&lt;?&gt; defineClass(Class&lt;?&gt; lookupClass, byte[] bytes) {
<span class="udiff-line-modified-removed">-         return AccessController.doPrivileged(new PrivilegedAction&lt;Class&lt;?&gt;&gt;() {</span>
<span class="udiff-line-modified-removed">-             @Override</span>
<span class="udiff-line-modified-removed">-             public Class&lt;?&gt; run() {</span>
<span class="udiff-line-modified-removed">-                 try {</span>
<span class="udiff-line-removed">-                     return MethodHandles.privateLookupIn(lookupClass, LOOKUP).defineClass(bytes);</span>
<span class="udiff-line-removed">-                 } catch (IllegalAccessException e) {</span>
<span class="udiff-line-removed">-                     throw new InternalError(e);</span>
<span class="udiff-line-removed">-                 }</span>
<span class="udiff-line-removed">-             }</span>
<span class="udiff-line-removed">-         });</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static Thread createThreadWitNoPermissions(String threadName, Runnable runnable) {</span>
<span class="udiff-line-removed">-         return doPrivilegedWithReturn(() -&gt; new Thread(runnable, threadName), new Permission[0]);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static void setDaemonThread(Thread t, boolean daemon) {</span>
<span class="udiff-line-removed">-       doPrivileged(()-&gt; t.setDaemon(daemon), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     public static SafePath getAbsolutePath(SafePath path) throws IOException {</span>
<span class="udiff-line-removed">-         return new SafePath(doPrivilegedIOWithReturn((()-&gt; path.toPath().toAbsolutePath())));</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     private static final class Privileged extends FileAccess {</span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public RandomAccessFile openRAF(File f, String mode) throws IOException {</span>
<span class="udiff-line-removed">-             return doPrivilegedIOWithReturn( () -&gt; new RandomAccessFile(f, mode));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public  DirectoryStream&lt;Path&gt; newDirectoryStream(Path directory)  throws IOException  {</span>
<span class="udiff-line-removed">-             return doPrivilegedIOWithReturn( () -&gt; Files.newDirectoryStream(directory));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public  String getAbsolutePath(File f) throws IOException {</span>
<span class="udiff-line-removed">-             return doPrivilegedIOWithReturn( () -&gt; f.getAbsolutePath());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public long length(File f) throws IOException {</span>
<span class="udiff-line-removed">-             return doPrivilegedIOWithReturn( () -&gt; f.length());</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public  long fileSize(Path p) throws IOException {</span>
<span class="udiff-line-removed">-             return doPrivilegedIOWithReturn( () -&gt; Files.size(p));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public boolean exists(Path p) throws IOException {</span>
<span class="udiff-line-removed">-             return doPrivilegedIOWithReturn( () -&gt; Files.exists(p));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public boolean isDirectory(Path p) {</span>
<span class="udiff-line-removed">-             return doPrivilegedWithReturn( () -&gt; Files.isDirectory(p));</span>
<span class="udiff-line-removed">-         }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         @Override</span>
<span class="udiff-line-removed">-         public FileTime getLastModified(Path p) throws IOException {</span>
<span class="udiff-line-removed">-             // Timestamp only needed when examining repository for other JVMs,</span>
<span class="udiff-line-removed">-             // in which case an unprivileged mode should be used.</span>
<span class="udiff-line-removed">-             throw new InternalError(&quot;Should not reach here&quot;);</span>
<span class="udiff-line-modified-added">+         try {</span>
<span class="udiff-line-modified-added">+             return MethodHandles.privateLookupIn(lookupClass, LOOKUP).defineClass(bytes);</span>
<span class="udiff-line-modified-added">+         } catch (IllegalAccessException e) {</span>
<span class="udiff-line-modified-added">+             throw new InternalError(e);</span>
          }
      }
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- </span>
  }
</pre>
<center><a href="RepositoryChunk.java.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="ShutdownHook.java.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>