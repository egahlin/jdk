<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff src/jdk.jfr/share/classes/jdk/jfr/internal/jfc/JFC.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../event/EventWriter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="model/JFCModel.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/internal/jfc/JFC.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2024, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (c) 2016, 2025, Oracle and/or its affiliates. All rights reserved.</span>
   * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   *
   * This code is free software; you can redistribute it and/or modify it
   * under the terms of the GNU General Public License version 2 only, as
   * published by the Free Software Foundation.  Oracle designates this
</pre>
<hr />
<pre>
<span class="line-old-header">*** 44,38 ***</span>
  import jdk.jfr.Configuration;
  import jdk.jfr.internal.jfc.model.JFCModelException;
  import jdk.jfr.internal.LogLevel;
  import jdk.jfr.internal.LogTag;
  import jdk.jfr.internal.Logger;
<span class="line-modified">! import jdk.jfr.internal.SecuritySupport;</span>
<span class="line-removed">- import jdk.jfr.internal.SecuritySupport.SafePath;</span>
  
  /**
   * {@link Configuration} factory for JFC files. *
   */
  public final class JFC {
      private static final int BUFFER_SIZE = 8192;
      private static final int MAXIMUM_FILE_SIZE = 1024 * 1024;
      private static final int MAX_BUFFER_SIZE = Integer.MAX_VALUE - 8;
      private static volatile List&lt;KnownConfiguration&gt; knownConfigurations;
  
      /**
       * Reads a known configuration file (located into a string, but doesn&#39;t
       * parse it until it&#39;s being used.
       */
      private static final class KnownConfiguration {
          private final String content;
          private final String filename;
          private final String name;
<span class="line-modified">!         private final SafePath path;</span>
          private Configuration configuration;
  
<span class="line-modified">!         public KnownConfiguration(SafePath knownPath) throws IOException {</span>
              this.path = knownPath;
              this.content = readContent(knownPath);
<span class="line-modified">!             this.name = nameFromPath(knownPath.toPath());</span>
<span class="line-modified">!             this.filename = nullSafeFileName(knownPath.toPath());</span>
          }
  
          public boolean isNamed(String name) {
              return filename.equals(name) || this.name.equals(name);
          }
<span class="line-new-header">--- 44,53 ---</span>
  import jdk.jfr.Configuration;
  import jdk.jfr.internal.jfc.model.JFCModelException;
  import jdk.jfr.internal.LogLevel;
  import jdk.jfr.internal.LogTag;
  import jdk.jfr.internal.Logger;
<span class="line-modified">! import jdk.jfr.internal.util.Utils;</span>
  
  /**
   * {@link Configuration} factory for JFC files. *
   */
  public final class JFC {
<span class="line-added">+     private static final Path JFC_DIRECTORY = Utils.getPathInProperty(&quot;java.home&quot;, &quot;lib/jfr&quot;);</span>
      private static final int BUFFER_SIZE = 8192;
      private static final int MAXIMUM_FILE_SIZE = 1024 * 1024;
      private static final int MAX_BUFFER_SIZE = Integer.MAX_VALUE - 8;
      private static volatile List&lt;KnownConfiguration&gt; knownConfigurations;
  
<span class="line-added">+     public static List&lt;Path&gt; getPredefined() {</span>
<span class="line-added">+         List&lt;Path&gt; list = new ArrayList&lt;&gt;();</span>
<span class="line-added">+         try (var ds = Files.newDirectoryStream(JFC_DIRECTORY)) {</span>
<span class="line-added">+             for (Path path : ds) {</span>
<span class="line-added">+                 String text = path.toString();</span>
<span class="line-added">+                 if (text.endsWith(&quot;.jfc&quot;) &amp;&amp; !Files.isDirectory(path)) {</span>
<span class="line-added">+                     list.add(path);</span>
<span class="line-added">+                 }</span>
<span class="line-added">+             }</span>
<span class="line-added">+         } catch (IOException ioe) {</span>
<span class="line-added">+             Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Could not access .jfc-files in &quot; + JFC_DIRECTORY + &quot;, &quot; + ioe.getMessage());</span>
<span class="line-added">+         }</span>
<span class="line-added">+         return list;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
      /**
       * Reads a known configuration file (located into a string, but doesn&#39;t
       * parse it until it&#39;s being used.
       */
      private static final class KnownConfiguration {
          private final String content;
          private final String filename;
          private final String name;
<span class="line-modified">!         private final Path path;</span>
          private Configuration configuration;
  
<span class="line-modified">!         public KnownConfiguration(Path knownPath) throws IOException {</span>
              this.path = knownPath;
              this.content = readContent(knownPath);
<span class="line-modified">!             this.name = nameFromPath(knownPath);</span>
<span class="line-modified">!             this.filename = nullSafeFileName(knownPath);</span>
          }
  
          public boolean isNamed(String name) {
              return filename.equals(name) || this.name.equals(name);
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 89,16 ***</span>
  
          public String getName() {
              return name;
          }
  
<span class="line-modified">!         private static String readContent(SafePath knownPath) throws IOException {</span>
<span class="line-modified">!             if (SecuritySupport.getFileSize(knownPath) &gt; MAXIMUM_FILE_SIZE) {</span>
                  throw new IOException(&quot;Configuration with more than &quot;
                          + MAXIMUM_FILE_SIZE + &quot; characters can&#39;t be read.&quot;);
              }
<span class="line-modified">!             try (InputStream r = SecuritySupport.newFileInputStream(knownPath)) {</span>
                  return JFC.readContent(r);
              }
          }
      }
  
<span class="line-new-header">--- 104,16 ---</span>
  
          public String getName() {
              return name;
          }
  
<span class="line-modified">!         private static String readContent(Path knownPath) throws IOException {</span>
<span class="line-modified">!             if (Files.size(knownPath) &gt; MAXIMUM_FILE_SIZE) {</span>
                  throw new IOException(&quot;Configuration with more than &quot;
                          + MAXIMUM_FILE_SIZE + &quot; characters can&#39;t be read.&quot;);
              }
<span class="line-modified">!             try (InputStream r = Files.newInputStream(knownPath);) {</span>
                  return JFC.readContent(r);
              }
          }
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 112,14 ***</span>
       * @param path the file containing the configuration, not {@code null}
       * @return {@link Configuration}, not {@code null}
       * @throws ParseException if the file can&#39;t be parsed
       * @throws IOException if the file can&#39;t be read
       *
<span class="line-removed">-      * @throws SecurityException if a security manager exists and its</span>
<span class="line-removed">-      *         {@code checkRead} method denies read access to the file</span>
       * @see java.io.File#getPath()
<span class="line-removed">-      * @see java.lang.SecurityManager#checkRead(java.lang.String)</span>
       */
      public static Configuration create(String name, Reader reader) throws IOException, ParseException {
          try {
              return JFCParser.createConfiguration(name, reader);
          } catch (ParseException pe) {
<span class="line-new-header">--- 127,11 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 134,24 ***</span>
       * i.e. &quot;default&quot; or &quot;profile.jfc&quot;, it will return the path for
       * the predefined path in the JDK.
       *
       * @param path textual representation of the path
       *
<span class="line-modified">!      * @return a safe path, not null</span>
       */
<span class="line-modified">!     public static SafePath createSafePath(String path) {</span>
<span class="line-modified">!         for (SafePath predefined : SecuritySupport.getPredefinedJFCFiles()) {</span>
              try {
<span class="line-modified">!                 String name = JFC.nameFromPath(predefined.toPath());</span>
                  if (name.equals(path) || (name + &quot;.jfc&quot;).equals(path)) {
                      return predefined;
                  }
              } catch (IOException e) {
                  throw new InternalError(&quot;Error in predefined .jfc file&quot;, e);
              }
          }
<span class="line-modified">!         return new SafePath(path);</span>
      }
  
  
      private static String nullSafeFileName(Path file) throws IOException {
          Path filename = file.getFileName();
<span class="line-new-header">--- 146,24 ---</span>
       * i.e. &quot;default&quot; or &quot;profile.jfc&quot;, it will return the path for
       * the predefined path in the JDK.
       *
       * @param path textual representation of the path
       *
<span class="line-modified">!      * @return a path, not null</span>
       */
<span class="line-modified">!     public static Path ofPath(String path) {</span>
<span class="line-modified">!         for (Path predefined : JFC.getPredefined()) {</span>
              try {
<span class="line-modified">!                 String name = JFC.nameFromPath(predefined);</span>
                  if (name.equals(path) || (name + &quot;.jfc&quot;).equals(path)) {
                      return predefined;
                  }
              } catch (IOException e) {
                  throw new InternalError(&quot;Error in predefined .jfc file&quot;, e);
              }
          }
<span class="line-modified">!         return Path.of(path);</span>
      }
  
  
      private static String nullSafeFileName(Path file) throws IOException {
          Path filename = file.getFileName();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 170,24 ***</span>
          }
      }
  
      // Invoked by DCmdStart
      public static Configuration createKnown(String name) throws IOException, ParseException {
<span class="line-removed">-         // Known name, no need for permission</span>
          for (KnownConfiguration known : getKnownConfigurations()) {
              if (known.isNamed(name)) {
                  return known.getConfigurationFile();
              }
          }
          // Check JFC directory
<span class="line-modified">!         SafePath path = SecuritySupport.JFC_DIRECTORY;</span>
<span class="line-modified">!         if (path != null &amp;&amp; SecuritySupport.exists(path)) {</span>
              for (String extension : Arrays.asList(&quot;&quot;, JFCParser.FILE_EXTENSION)) {
<span class="line-modified">!                 SafePath file = new SafePath(path.toPath().resolveSibling(name + extension));</span>
<span class="line-modified">!                 if (SecuritySupport.exists(file) &amp;&amp; !SecuritySupport.isDirectory(file)) {</span>
<span class="line-modified">!                     try (Reader r = SecuritySupport.newFileReader(file)) {</span>
<span class="line-modified">!                         String jfcName = nameFromPath(file.toPath());</span>
                          return JFCParser.createConfiguration(jfcName, r);
                      }
                  }
              }
          }
<span class="line-new-header">--- 182,23 ---</span>
          }
      }
  
      // Invoked by DCmdStart
      public static Configuration createKnown(String name) throws IOException, ParseException {
          for (KnownConfiguration known : getKnownConfigurations()) {
              if (known.isNamed(name)) {
                  return known.getConfigurationFile();
              }
          }
          // Check JFC directory
<span class="line-modified">!         Path path = JFC_DIRECTORY;</span>
<span class="line-modified">!         if (path != null &amp;&amp; Files.exists(path)) {</span>
              for (String extension : Arrays.asList(&quot;&quot;, JFCParser.FILE_EXTENSION)) {
<span class="line-modified">!                 Path file = path.resolveSibling(name + extension);</span>
<span class="line-modified">!                 if (Files.exists(file) &amp;&amp; !Files.isDirectory(file)) {</span>
<span class="line-modified">!                     try (Reader r = Files.newBufferedReader(file);) {</span>
<span class="line-modified">!                         String jfcName = nameFromPath(file);</span>
                          return JFCParser.createConfiguration(jfcName, r);
                      }
                  }
              }
          }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 258,11 ***</span>
      }
  
      private static List&lt;KnownConfiguration&gt; getKnownConfigurations() {
          if (knownConfigurations == null) {
              List&lt;KnownConfiguration&gt; configProxies = new ArrayList&lt;&gt;();
<span class="line-modified">!             for (SafePath p : SecuritySupport.getPredefinedJFCFiles()) {</span>
                  try {
                      configProxies.add(new KnownConfiguration(p));
                  } catch (IOException ioe) {
                      // ignore
                  }
<span class="line-new-header">--- 269,11 ---</span>
      }
  
      private static List&lt;KnownConfiguration&gt; getKnownConfigurations() {
          if (knownConfigurations == null) {
              List&lt;KnownConfiguration&gt; configProxies = new ArrayList&lt;&gt;();
<span class="line-modified">!             for (Path p : JFC.getPredefined()) {</span>
                  try {
                      configProxies.add(new KnownConfiguration(p));
                  } catch (IOException ioe) {
                      // ignore
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 279,11 ***</span>
              }
          }
          throw new NoSuchFileException(&quot;Could not locate configuration with name &quot; + name);
      }
  
<span class="line-modified">!     public static Reader newReader(SafePath sf) throws IOException {</span>
          for (KnownConfiguration c : getKnownConfigurations()) {
              if (c.path.equals(sf)) {
                  return new StringReader(c.content);
              }
          }
<span class="line-new-header">--- 290,11 ---</span>
              }
          }
          throw new NoSuchFileException(&quot;Could not locate configuration with name &quot; + name);
      }
  
<span class="line-modified">!     public static Reader newReader(Path sf) throws IOException {</span>
          for (KnownConfiguration c : getKnownConfigurations()) {
              if (c.path.equals(sf)) {
                  return new StringReader(c.content);
              }
          }
</pre>
<center><a href="../event/EventWriter.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="model/JFCModel.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>