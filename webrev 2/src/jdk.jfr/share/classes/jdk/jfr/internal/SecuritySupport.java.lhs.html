<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/jdk.jfr/share/classes/jdk/jfr/internal/SecuritySupport.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
<a name="1" id="anc1"></a><span class="line-modified">  2  * Copyright (c) 2016, 2024, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.internal;
 27 
<a name="2" id="anc2"></a><span class="line-removed"> 28 import java.io.File;</span>
<span class="line-removed"> 29 import java.io.FileNotFoundException;</span>
<span class="line-removed"> 30 import java.io.IOException;</span>
<span class="line-removed"> 31 import java.io.InputStream;</span>
<span class="line-removed"> 32 import java.io.RandomAccessFile;</span>
<span class="line-removed"> 33 import java.io.Reader;</span>
 34 import java.lang.invoke.MethodHandles;
<a name="3" id="anc3"></a><span class="line-removed"> 35 import java.lang.reflect.Constructor;</span>
<span class="line-removed"> 36 import java.lang.reflect.Method;</span>
<span class="line-removed"> 37 import java.lang.reflect.ReflectPermission;</span>
<span class="line-removed"> 38 import java.nio.channels.FileChannel;</span>
<span class="line-removed"> 39 import java.nio.channels.ReadableByteChannel;</span>
<span class="line-removed"> 40 import java.nio.file.DirectoryStream;</span>
<span class="line-removed"> 41 import java.nio.file.FileVisitResult;</span>
<span class="line-removed"> 42 import java.nio.file.Files;</span>
<span class="line-removed"> 43 import java.nio.file.LinkOption;</span>
<span class="line-removed"> 44 import java.nio.file.Path;</span>
<span class="line-removed"> 45 import java.nio.file.Paths;</span>
<span class="line-removed"> 46 import java.nio.file.SimpleFileVisitor;</span>
<span class="line-removed"> 47 import java.nio.file.StandardOpenOption;</span>
<span class="line-removed"> 48 import java.nio.file.attribute.BasicFileAttributes;</span>
<span class="line-removed"> 49 import java.nio.file.attribute.FileTime;</span>
<span class="line-removed"> 50 import java.security.AccessControlContext;</span>
<span class="line-removed"> 51 import java.security.AccessController;</span>
<span class="line-removed"> 52 import java.security.Permission;</span>
<span class="line-removed"> 53 import java.security.PrivilegedAction;</span>
<span class="line-removed"> 54 import java.security.PrivilegedActionException;</span>
<span class="line-removed"> 55 import java.security.PrivilegedExceptionAction;</span>
<span class="line-removed"> 56 import java.util.ArrayList;</span>
<span class="line-removed"> 57 import java.util.List;</span>
<span class="line-removed"> 58 import java.util.Objects;</span>
<span class="line-removed"> 59 import java.util.PropertyPermission;</span>
<span class="line-removed"> 60 import java.util.concurrent.Callable;</span>
<span class="line-removed"> 61 </span>
 62 import jdk.internal.module.Modules;
 63 import jdk.jfr.Event;
<a name="4" id="anc4"></a><span class="line-removed"> 64 import jdk.jfr.FlightRecorder;</span>
<span class="line-removed"> 65 import jdk.jfr.FlightRecorderListener;</span>
<span class="line-removed"> 66 import jdk.jfr.FlightRecorderPermission;</span>
<span class="line-removed"> 67 import jdk.jfr.Recording;</span>
<span class="line-removed"> 68 import jdk.jfr.internal.consumer.FileAccess;</span>
 69 
<a name="5" id="anc5"></a><span class="line-removed"> 70 /**</span>
<span class="line-removed"> 71  * Contains JFR code that does</span>
<span class="line-removed"> 72  * {@link AccessController#doPrivileged(PrivilegedAction)}</span>
<span class="line-removed"> 73  */</span>
 74 public final class SecuritySupport {
<a name="6" id="anc6"></a><span class="line-removed"> 75     private static final String EVENTS_PACKAGE_NAME = &quot;jdk.jfr.events&quot;;</span>
<span class="line-removed"> 76     private static final String EVENT_PACKAGE_NAME = &quot;jdk.jfr.internal.event&quot;;</span>
<span class="line-removed"> 77 </span>
<span class="line-removed"> 78     public static final String REGISTER_EVENT = &quot;registerEvent&quot;;</span>
<span class="line-removed"> 79     public static final String ACCESS_FLIGHT_RECORDER = &quot;accessFlightRecorder&quot;;</span>
<span class="line-removed"> 80     private static final MethodHandles.Lookup LOOKUP = MethodHandles.lookup();</span>
 81     private static final Module JFR_MODULE = Event.class.getModule();
<a name="7" id="anc7"></a><span class="line-modified"> 82     public  static final SafePath JFC_DIRECTORY = getPathInProperty(&quot;java.home&quot;, &quot;lib/jfr&quot;);</span>
<span class="line-removed"> 83     public static final FileAccess PRIVILEGED = new Privileged();</span>
<span class="line-removed"> 84     static final SafePath JAVA_IO_TMPDIR = getPathInProperty(&quot;java.io.tmpdir&quot;, null);</span>
 85 
 86     static {
 87         // ensure module java.base can read module jdk.jfr as early as possible
 88         addReadEdge(Object.class);
 89         addInternalEventExport(Object.class);
 90         addEventsExport(Object.class);
 91     }
 92 
<a name="8" id="anc8"></a><span class="line-removed"> 93     static final class SecureRecorderListener implements FlightRecorderListener {</span>
<span class="line-removed"> 94 </span>
<span class="line-removed"> 95         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed"> 96         private final AccessControlContext context;</span>
<span class="line-removed"> 97         private final FlightRecorderListener changeListener;</span>
<span class="line-removed"> 98 </span>
<span class="line-removed"> 99         SecureRecorderListener(@SuppressWarnings(&quot;removal&quot;) AccessControlContext context, FlightRecorderListener changeListener) {</span>
<span class="line-removed">100             this.context = Objects.requireNonNull(context);</span>
<span class="line-removed">101             this.changeListener = Objects.requireNonNull(changeListener);</span>
<span class="line-removed">102         }</span>
<span class="line-removed">103 </span>
<span class="line-removed">104         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">105         @Override</span>
<span class="line-removed">106         public void recordingStateChanged(Recording recording) {</span>
<span class="line-removed">107             AccessController.doPrivileged((PrivilegedAction&lt;Void&gt;) () -&gt; {</span>
<span class="line-removed">108                 try {</span>
<span class="line-removed">109                     changeListener.recordingStateChanged(recording);</span>
<span class="line-removed">110                 } catch (Throwable t) {</span>
<span class="line-removed">111                     // Prevent malicious user to propagate exception callback in the wrong context</span>
<span class="line-removed">112                     Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Unexpected exception in listener &quot; + changeListener.getClass()+ &quot; at recording state change&quot;);</span>
<span class="line-removed">113                 }</span>
<span class="line-removed">114                 return null;</span>
<span class="line-removed">115             }, context);</span>
<span class="line-removed">116         }</span>
<span class="line-removed">117 </span>
<span class="line-removed">118         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">119         @Override</span>
<span class="line-removed">120         public void recorderInitialized(FlightRecorder recorder) {</span>
<span class="line-removed">121             AccessController.doPrivileged((PrivilegedAction&lt;Void&gt;) () -&gt; {</span>
<span class="line-removed">122                 try  {</span>
<span class="line-removed">123                     changeListener.recorderInitialized(recorder);</span>
<span class="line-removed">124                 } catch (Throwable t) {</span>
<span class="line-removed">125                     // Prevent malicious user to propagate exception callback in the wrong context</span>
<span class="line-removed">126                     Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Unexpected exception in listener &quot; + changeListener.getClass()+ &quot; when initializing FlightRecorder&quot;);</span>
<span class="line-removed">127                 }</span>
<span class="line-removed">128                 return null;</span>
<span class="line-removed">129             }, context);</span>
<span class="line-removed">130         }</span>
<span class="line-removed">131 </span>
<span class="line-removed">132         public FlightRecorderListener getChangeListener() {</span>
<span class="line-removed">133             return changeListener;</span>
<span class="line-removed">134         }</span>
<span class="line-removed">135     }</span>
<span class="line-removed">136 </span>
<span class="line-removed">137     private static final class DirectoryCleaner extends SimpleFileVisitor&lt;Path&gt; {</span>
<span class="line-removed">138         @Override</span>
<span class="line-removed">139         public FileVisitResult visitFile(Path path, BasicFileAttributes attrs) throws IOException {</span>
<span class="line-removed">140             Files.delete(path);</span>
<span class="line-removed">141             return FileVisitResult.CONTINUE;</span>
<span class="line-removed">142         }</span>
<span class="line-removed">143 </span>
<span class="line-removed">144         @Override</span>
<span class="line-removed">145         public FileVisitResult postVisitDirectory(Path dir, IOException exc) throws IOException {</span>
<span class="line-removed">146             if (exc != null) {</span>
<span class="line-removed">147                 throw exc;</span>
<span class="line-removed">148             }</span>
<span class="line-removed">149             Files.delete(dir);</span>
<span class="line-removed">150             return FileVisitResult.CONTINUE;</span>
<span class="line-removed">151         }</span>
<span class="line-removed">152     }</span>
<span class="line-removed">153 </span>
<span class="line-removed">154     /**</span>
<span class="line-removed">155      * Path created by the default file provider, and not</span>
<span class="line-removed">156      * a malicious provider.</span>
<span class="line-removed">157      *</span>
<span class="line-removed">158      */</span>
<span class="line-removed">159     public static final class SafePath implements Comparable&lt;SafePath&gt; {</span>
<span class="line-removed">160         private final Path path;</span>
<span class="line-removed">161         private final String text;</span>
<span class="line-removed">162 </span>
<span class="line-removed">163         public SafePath(Path p) {</span>
<span class="line-removed">164             // sanitize</span>
<span class="line-removed">165             text = p.toString();</span>
<span class="line-removed">166             path = Paths.get(text);</span>
<span class="line-removed">167         }</span>
<span class="line-removed">168 </span>
<span class="line-removed">169         public SafePath(String path) {</span>
<span class="line-removed">170             this(Paths.get(path));</span>
<span class="line-removed">171         }</span>
<span class="line-removed">172 </span>
<span class="line-removed">173         public Path toPath() {</span>
<span class="line-removed">174             return path;</span>
<span class="line-removed">175         }</span>
<span class="line-removed">176 </span>
<span class="line-removed">177         public File toFile() {</span>
<span class="line-removed">178             return path.toFile();</span>
<span class="line-removed">179         }</span>
<span class="line-removed">180 </span>
<span class="line-removed">181         @Override</span>
<span class="line-removed">182         public String toString() {</span>
<span class="line-removed">183             return text;</span>
<span class="line-removed">184         }</span>
<span class="line-removed">185 </span>
<span class="line-removed">186         @Override</span>
<span class="line-removed">187         public int compareTo(SafePath that) {</span>
<span class="line-removed">188             return that.text.compareTo(this.text);</span>
<span class="line-removed">189         }</span>
<span class="line-removed">190 </span>
<span class="line-removed">191         @Override</span>
<span class="line-removed">192         public boolean equals(Object other) {</span>
<span class="line-removed">193             if(other != null &amp;&amp; other instanceof SafePath s){</span>
<span class="line-removed">194                 return this.toPath().equals(s.toPath());</span>
<span class="line-removed">195             }</span>
<span class="line-removed">196             return false;</span>
<span class="line-removed">197         }</span>
<span class="line-removed">198 </span>
<span class="line-removed">199         @Override</span>
<span class="line-removed">200         public int hashCode() {</span>
<span class="line-removed">201             return this.toPath().hashCode();</span>
<span class="line-removed">202         }</span>
<span class="line-removed">203     }</span>
<span class="line-removed">204 </span>
<span class="line-removed">205     private interface RunnableWithCheckedException {</span>
<span class="line-removed">206         public void run() throws Exception;</span>
<span class="line-removed">207     }</span>
<span class="line-removed">208 </span>
<span class="line-removed">209     private interface CallableWithoutCheckException&lt;T&gt; {</span>
<span class="line-removed">210         public T call();</span>
<span class="line-removed">211     }</span>
<span class="line-removed">212 </span>
<span class="line-removed">213     public static void checkAccessFlightRecorder() throws SecurityException {</span>
<span class="line-removed">214         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">215         SecurityManager sm = System.getSecurityManager();</span>
<span class="line-removed">216         if (sm != null) {</span>
<span class="line-removed">217             sm.checkPermission(new FlightRecorderPermission(ACCESS_FLIGHT_RECORDER));</span>
<span class="line-removed">218         }</span>
<span class="line-removed">219     }</span>
<span class="line-removed">220 </span>
<span class="line-removed">221     public static void checkRegisterPermission() throws SecurityException {</span>
<span class="line-removed">222         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">223         SecurityManager sm = System.getSecurityManager();</span>
<span class="line-removed">224         if (sm != null) {</span>
<span class="line-removed">225             sm.checkPermission(new FlightRecorderPermission(REGISTER_EVENT));</span>
<span class="line-removed">226         }</span>
<span class="line-removed">227     }</span>
<span class="line-removed">228 </span>
<span class="line-removed">229     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">230     private static &lt;U&gt; U doPrivilegedIOWithReturn(Callable&lt;U&gt; function) throws IOException {</span>
<span class="line-removed">231         try {</span>
<span class="line-removed">232             return AccessController.doPrivileged(new PrivilegedExceptionAction&lt;U&gt;() {</span>
<span class="line-removed">233                 @Override</span>
<span class="line-removed">234                 public U run() throws Exception {</span>
<span class="line-removed">235                     return function.call();</span>
<span class="line-removed">236                 }</span>
<span class="line-removed">237             }, null);</span>
<span class="line-removed">238         } catch (PrivilegedActionException e) {</span>
<span class="line-removed">239             Throwable t = e.getCause();</span>
<span class="line-removed">240             if (t instanceof IOException) {</span>
<span class="line-removed">241                 throw (IOException) t;</span>
<span class="line-removed">242             }</span>
<span class="line-removed">243             throw new IOException(&quot;Unexpected error during I/O operation. &quot; + t.getMessage(), t);</span>
<span class="line-removed">244         }</span>
<span class="line-removed">245     }</span>
<span class="line-removed">246 </span>
<span class="line-removed">247     private static void doPriviligedIO(RunnableWithCheckedException function) throws IOException {</span>
<span class="line-removed">248         doPrivilegedIOWithReturn(() -&gt; {</span>
<span class="line-removed">249             function.run();</span>
<span class="line-removed">250             return null;</span>
<span class="line-removed">251         });</span>
<span class="line-removed">252     }</span>
<span class="line-removed">253 </span>
<span class="line-removed">254     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">255     private static void doPrivileged(Runnable function, Permission... perms) {</span>
<span class="line-removed">256         AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
<span class="line-removed">257             @Override</span>
<span class="line-removed">258             public Void run() {</span>
<span class="line-removed">259                 function.run();</span>
<span class="line-removed">260                 return null;</span>
<span class="line-removed">261             }</span>
<span class="line-removed">262         }, null, perms);</span>
<span class="line-removed">263     }</span>
<span class="line-removed">264 </span>
<span class="line-removed">265     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">266     private static void doPrivileged(Runnable function) {</span>
<span class="line-removed">267         AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() {</span>
<span class="line-removed">268             @Override</span>
<span class="line-removed">269             public Void run() {</span>
<span class="line-removed">270                 function.run();</span>
<span class="line-removed">271                 return null;</span>
<span class="line-removed">272             }</span>
<span class="line-removed">273         });</span>
<span class="line-removed">274     }</span>
<span class="line-removed">275 </span>
<span class="line-removed">276     @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">277     private static &lt;T&gt; T doPrivilegedWithReturn(CallableWithoutCheckException&lt;T&gt; function, Permission... perms) {</span>
<span class="line-removed">278         return AccessController.doPrivileged(new PrivilegedAction&lt;T&gt;() {</span>
<span class="line-removed">279             @Override</span>
<span class="line-removed">280             public T run() {</span>
<span class="line-removed">281                 return function.call();</span>
<span class="line-removed">282             }</span>
<span class="line-removed">283         }, null, perms);</span>
<span class="line-removed">284     }</span>
<span class="line-removed">285 </span>
<span class="line-removed">286     public static List&lt;SafePath&gt; getPredefinedJFCFiles() {</span>
<span class="line-removed">287         List&lt;SafePath&gt; list = new ArrayList&lt;&gt;();</span>
<span class="line-removed">288         try (var ds = doPrivilegedIOWithReturn(() -&gt; Files.newDirectoryStream(JFC_DIRECTORY.toPath()))) {</span>
<span class="line-removed">289             for (Path path : ds) {</span>
<span class="line-removed">290                 SafePath s = new SafePath(path);</span>
<span class="line-removed">291                 String text = s.toString();</span>
<span class="line-removed">292                 if (text.endsWith(&quot;.jfc&quot;) &amp;&amp; !SecuritySupport.isDirectory(s)) {</span>
<span class="line-removed">293                     list.add(s);</span>
<span class="line-removed">294                 }</span>
<span class="line-removed">295             }</span>
<span class="line-removed">296         } catch (IOException ioe) {</span>
<span class="line-removed">297             Logger.log(LogTag.JFR, LogLevel.WARN, &quot;Could not access .jfc-files in &quot; + JFC_DIRECTORY + &quot;, &quot; + ioe.getMessage());</span>
<span class="line-removed">298         }</span>
<span class="line-removed">299         return list;</span>
<span class="line-removed">300     }</span>
<span class="line-removed">301 </span>
302     static void makeVisibleToJFR(Class&lt;?&gt; clazz) {
303         Module classModule = clazz.getModule();
304         Modules.addReads(JFR_MODULE, classModule);
305         if (clazz.getPackage() != null) {
306             String packageName = clazz.getPackage().getName();
307             Modules.addExports(classModule, packageName, JFR_MODULE);
308             Modules.addOpens(classModule, packageName, JFR_MODULE);
309         }
310     }
311 
312     /**
313      * Adds a qualified export of the internal.jdk.jfr.internal.event package
314      * (for EventConfiguration and EventWriter)
315      */
316     static void addInternalEventExport(Class&lt;?&gt; clazz) {
<a name="9" id="anc9"></a><span class="line-modified">317         Modules.addExports(JFR_MODULE, EVENT_PACKAGE_NAME, clazz.getModule());</span>
318     }
319 
320     static void addEventsExport(Class&lt;?&gt; clazz) {
<a name="10" id="anc10"></a><span class="line-modified">321         Modules.addExports(JFR_MODULE, EVENTS_PACKAGE_NAME, clazz.getModule());</span>
322     }
323 
324     static void addReadEdge(Class&lt;?&gt; clazz) {
325         Modules.addReads(clazz.getModule(), JFR_MODULE);
326     }
327 
<a name="11" id="anc11"></a><span class="line-removed">328     public static void registerEvent(Class&lt;? extends jdk.internal.event.Event&gt; eventClass) {</span>
<span class="line-removed">329         doPrivileged(() -&gt;  MetadataRepository.getInstance().register(eventClass), new FlightRecorderPermission(REGISTER_EVENT));</span>
<span class="line-removed">330     }</span>
<span class="line-removed">331 </span>
<span class="line-removed">332     public static void setProperty(String propertyName, String value) {</span>
<span class="line-removed">333         doPrivileged(() -&gt; System.setProperty(propertyName, value), new PropertyPermission(propertyName, &quot;write&quot;));</span>
<span class="line-removed">334     }</span>
<span class="line-removed">335 </span>
<span class="line-removed">336     static boolean getBooleanProperty(String propertyName) {</span>
<span class="line-removed">337         return doPrivilegedWithReturn(() -&gt; Boolean.getBoolean(propertyName), new PropertyPermission(propertyName, &quot;read&quot;));</span>
<span class="line-removed">338     }</span>
<span class="line-removed">339 </span>
<span class="line-removed">340     private static SafePath getPathInProperty(String prop, String subPath) {</span>
<span class="line-removed">341         return doPrivilegedWithReturn(() -&gt; {</span>
<span class="line-removed">342             String path = System.getProperty(prop);</span>
<span class="line-removed">343             if (path == null) {</span>
<span class="line-removed">344                 return null;</span>
<span class="line-removed">345             }</span>
<span class="line-removed">346             File file = subPath == null ? new File(path) : new File(path, subPath);</span>
<span class="line-removed">347             return new SafePath(file.getAbsolutePath());</span>
<span class="line-removed">348         }, new PropertyPermission(&quot;*&quot;, &quot;read&quot;));</span>
<span class="line-removed">349     }</span>
<span class="line-removed">350 </span>
<span class="line-removed">351     // Called by JVM during initialization of JFR</span>
<span class="line-removed">352     static Thread createRecorderThread(ThreadGroup systemThreadGroup, ClassLoader contextClassLoader) {</span>
<span class="line-removed">353         // The thread should have permission = new Permission[0], and not &quot;modifyThreadGroup&quot; and &quot;modifyThread&quot; on the stack,</span>
<span class="line-removed">354         // but it&#39;s hard circumvent if we are going to pass in system thread group in the constructor</span>
<span class="line-removed">355         Thread thread = doPrivilegedWithReturn(() -&gt; new Thread(systemThreadGroup, &quot;JFR Recorder Thread&quot;), new RuntimePermission(&quot;modifyThreadGroup&quot;), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="line-removed">356         doPrivileged(() -&gt; thread.setContextClassLoader(contextClassLoader), new RuntimePermission(&quot;setContextClassLoader&quot;), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="line-removed">357         return thread;</span>
<span class="line-removed">358     }</span>
<span class="line-removed">359 </span>
<span class="line-removed">360     static void registerShutdownHook(Thread shutdownHook) {</span>
<span class="line-removed">361         doPrivileged(() -&gt; Runtime.getRuntime().addShutdownHook(shutdownHook), new RuntimePermission(&quot;shutdownHooks&quot;));</span>
<span class="line-removed">362     }</span>
<span class="line-removed">363 </span>
<span class="line-removed">364     static void setUncaughtExceptionHandler(Thread thread, Thread.UncaughtExceptionHandler eh) {</span>
<span class="line-removed">365         doPrivileged(() -&gt; thread.setUncaughtExceptionHandler(eh), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="line-removed">366     }</span>
<span class="line-removed">367 </span>
<span class="line-removed">368     static void clearDirectory(SafePath safePath) throws IOException {</span>
<span class="line-removed">369         doPriviligedIO(() -&gt; Files.walkFileTree(safePath.toPath(), new DirectoryCleaner()));</span>
<span class="line-removed">370     }</span>
<span class="line-removed">371 </span>
<span class="line-removed">372     static SafePath toRealPath(SafePath safePath, LinkOption... options) throws IOException {</span>
<span class="line-removed">373         return new SafePath(doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toRealPath(options)));</span>
<span class="line-removed">374     }</span>
<span class="line-removed">375 </span>
<span class="line-removed">376     static boolean existDirectory(SafePath directory) throws IOException {</span>
<span class="line-removed">377         return doPrivilegedIOWithReturn(() -&gt; Files.exists(directory.toPath()));</span>
<span class="line-removed">378     }</span>
<span class="line-removed">379 </span>
<span class="line-removed">380     static RandomAccessFile createRandomAccessFile(SafePath path) throws Exception {</span>
<span class="line-removed">381         return doPrivilegedIOWithReturn(() -&gt; new RandomAccessFile(path.toPath().toFile(), &quot;rw&quot;));</span>
<span class="line-removed">382     }</span>
<span class="line-removed">383 </span>
<span class="line-removed">384     public static InputStream newFileInputStream(SafePath safePath) throws IOException {</span>
<span class="line-removed">385         return doPrivilegedIOWithReturn(() -&gt; Files.newInputStream(safePath.toPath()));</span>
<span class="line-removed">386     }</span>
<span class="line-removed">387 </span>
<span class="line-removed">388     public static long getFileSize(SafePath safePath) throws IOException {</span>
<span class="line-removed">389         return doPrivilegedIOWithReturn(() -&gt; Files.size(safePath.toPath()));</span>
<span class="line-removed">390     }</span>
<span class="line-removed">391 </span>
<span class="line-removed">392     static SafePath createDirectories(SafePath safePath) throws IOException {</span>
<span class="line-removed">393         Path p = doPrivilegedIOWithReturn(() -&gt; Files.createDirectories(safePath.toPath()));</span>
<span class="line-removed">394         return new SafePath(p);</span>
<span class="line-removed">395     }</span>
<span class="line-removed">396 </span>
<span class="line-removed">397     public static boolean exists(SafePath safePath) throws IOException {</span>
<span class="line-removed">398         // Files.exist(path) is allocation intensive</span>
<span class="line-removed">399         return doPrivilegedIOWithReturn(() -&gt; safePath.toPath().toFile().exists());</span>
<span class="line-removed">400     }</span>
<span class="line-removed">401 </span>
<span class="line-removed">402     public static boolean isDirectory(SafePath safePath) throws IOException {</span>
<span class="line-removed">403         return doPrivilegedIOWithReturn(() -&gt; Files.isDirectory(safePath.toPath()));</span>
<span class="line-removed">404     }</span>
<span class="line-removed">405 </span>
<span class="line-removed">406     static void delete(SafePath localPath) throws IOException {</span>
<span class="line-removed">407         doPriviligedIO(() -&gt; Files.delete(localPath.toPath()));</span>
<span class="line-removed">408     }</span>
<span class="line-removed">409 </span>
<span class="line-removed">410     static boolean isWritable(SafePath safePath) throws IOException {</span>
<span class="line-removed">411         return doPrivilegedIOWithReturn(() -&gt; Files.isWritable(safePath.toPath()));</span>
<span class="line-removed">412     }</span>
<span class="line-removed">413 </span>
<span class="line-removed">414     static ReadableByteChannel newFileChannelToRead(SafePath safePath) throws IOException {</span>
<span class="line-removed">415         return doPrivilegedIOWithReturn(() -&gt; FileChannel.open(safePath.toPath(), StandardOpenOption.READ));</span>
<span class="line-removed">416     }</span>
<span class="line-removed">417 </span>
<span class="line-removed">418     public static InputStream getResourceAsStream(String name) throws IOException {</span>
<span class="line-removed">419         return doPrivilegedIOWithReturn(() -&gt; SecuritySupport.class.getResourceAsStream(name));</span>
<span class="line-removed">420     }</span>
<span class="line-removed">421 </span>
<span class="line-removed">422     public static Reader newFileReader(SafePath safePath) throws FileNotFoundException, IOException {</span>
<span class="line-removed">423         return doPrivilegedIOWithReturn(() -&gt; Files.newBufferedReader(safePath.toPath()));</span>
<span class="line-removed">424     }</span>
<span class="line-removed">425 </span>
<span class="line-removed">426     static void setAccessible(Method method) {</span>
<span class="line-removed">427         doPrivileged(() -&gt; method.setAccessible(true), new ReflectPermission(&quot;suppressAccessChecks&quot;));</span>
<span class="line-removed">428     }</span>
<span class="line-removed">429 </span>
<span class="line-removed">430     static void setAccessible(Constructor&lt;?&gt; constructor) {</span>
<span class="line-removed">431         doPrivileged(() -&gt; constructor.setAccessible(true), new ReflectPermission(&quot;suppressAccessChecks&quot;));</span>
<span class="line-removed">432     }</span>
<span class="line-removed">433 </span>
<span class="line-removed">434     @SuppressWarnings(&quot;removal&quot;)</span>
435     public static void ensureClassIsInitialized(Class&lt;?&gt; clazz) {
436         try {
<a name="12" id="anc12"></a><span class="line-modified">437             MethodHandles.Lookup lookup;</span>
<span class="line-removed">438             if (System.getSecurityManager() == null) {</span>
<span class="line-removed">439                 lookup = MethodHandles.privateLookupIn(clazz, LOOKUP);</span>
<span class="line-removed">440             } else {</span>
<span class="line-removed">441                 lookup = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;&gt;() {</span>
<span class="line-removed">442                     @Override</span>
<span class="line-removed">443                     public MethodHandles.Lookup run() throws IllegalAccessException {</span>
<span class="line-removed">444                         return MethodHandles.privateLookupIn(clazz, LOOKUP);</span>
<span class="line-removed">445                     }</span>
<span class="line-removed">446                 }, null, new ReflectPermission(&quot;suppressAccessChecks&quot;));</span>
<span class="line-removed">447             }</span>
448             lookup.ensureInitialized(clazz);
449         } catch (IllegalAccessException e) {
450             throw new InternalError(e);
<a name="13" id="anc13"></a><span class="line-removed">451         } catch (PrivilegedActionException e) {</span>
<span class="line-removed">452             throw new InternalError(e.getCause());</span>
453         }
454     }
455 
<a name="14" id="anc14"></a><span class="line-removed">456     @SuppressWarnings(&quot;removal&quot;)</span>
457     static Class&lt;?&gt; defineClass(Class&lt;?&gt; lookupClass, byte[] bytes) {
<a name="15" id="anc15"></a><span class="line-modified">458         return AccessController.doPrivileged(new PrivilegedAction&lt;Class&lt;?&gt;&gt;() {</span>
<span class="line-modified">459             @Override</span>
<span class="line-modified">460             public Class&lt;?&gt; run() {</span>
<span class="line-modified">461                 try {</span>
<span class="line-removed">462                     return MethodHandles.privateLookupIn(lookupClass, LOOKUP).defineClass(bytes);</span>
<span class="line-removed">463                 } catch (IllegalAccessException e) {</span>
<span class="line-removed">464                     throw new InternalError(e);</span>
<span class="line-removed">465                 }</span>
<span class="line-removed">466             }</span>
<span class="line-removed">467         });</span>
<span class="line-removed">468     }</span>
<span class="line-removed">469 </span>
<span class="line-removed">470     public static Thread createThreadWitNoPermissions(String threadName, Runnable runnable) {</span>
<span class="line-removed">471         return doPrivilegedWithReturn(() -&gt; new Thread(runnable, threadName), new Permission[0]);</span>
<span class="line-removed">472     }</span>
<span class="line-removed">473 </span>
<span class="line-removed">474     public static void setDaemonThread(Thread t, boolean daemon) {</span>
<span class="line-removed">475       doPrivileged(()-&gt; t.setDaemon(daemon), new RuntimePermission(&quot;modifyThread&quot;));</span>
<span class="line-removed">476     }</span>
<span class="line-removed">477 </span>
<span class="line-removed">478     public static SafePath getAbsolutePath(SafePath path) throws IOException {</span>
<span class="line-removed">479         return new SafePath(doPrivilegedIOWithReturn((()-&gt; path.toPath().toAbsolutePath())));</span>
<span class="line-removed">480     }</span>
<span class="line-removed">481 </span>
<span class="line-removed">482     private static final class Privileged extends FileAccess {</span>
<span class="line-removed">483         @Override</span>
<span class="line-removed">484         public RandomAccessFile openRAF(File f, String mode) throws IOException {</span>
<span class="line-removed">485             return doPrivilegedIOWithReturn( () -&gt; new RandomAccessFile(f, mode));</span>
<span class="line-removed">486         }</span>
<span class="line-removed">487 </span>
<span class="line-removed">488         @Override</span>
<span class="line-removed">489         public  DirectoryStream&lt;Path&gt; newDirectoryStream(Path directory)  throws IOException  {</span>
<span class="line-removed">490             return doPrivilegedIOWithReturn( () -&gt; Files.newDirectoryStream(directory));</span>
<span class="line-removed">491         }</span>
<span class="line-removed">492 </span>
<span class="line-removed">493         @Override</span>
<span class="line-removed">494         public  String getAbsolutePath(File f) throws IOException {</span>
<span class="line-removed">495             return doPrivilegedIOWithReturn( () -&gt; f.getAbsolutePath());</span>
<span class="line-removed">496         }</span>
<span class="line-removed">497         @Override</span>
<span class="line-removed">498         public long length(File f) throws IOException {</span>
<span class="line-removed">499             return doPrivilegedIOWithReturn( () -&gt; f.length());</span>
<span class="line-removed">500         }</span>
<span class="line-removed">501 </span>
<span class="line-removed">502         @Override</span>
<span class="line-removed">503         public  long fileSize(Path p) throws IOException {</span>
<span class="line-removed">504             return doPrivilegedIOWithReturn( () -&gt; Files.size(p));</span>
<span class="line-removed">505         }</span>
<span class="line-removed">506 </span>
<span class="line-removed">507         @Override</span>
<span class="line-removed">508         public boolean exists(Path p) throws IOException {</span>
<span class="line-removed">509             return doPrivilegedIOWithReturn( () -&gt; Files.exists(p));</span>
<span class="line-removed">510         }</span>
<span class="line-removed">511 </span>
<span class="line-removed">512         @Override</span>
<span class="line-removed">513         public boolean isDirectory(Path p) {</span>
<span class="line-removed">514             return doPrivilegedWithReturn( () -&gt; Files.isDirectory(p));</span>
<span class="line-removed">515         }</span>
<span class="line-removed">516 </span>
<span class="line-removed">517         @Override</span>
<span class="line-removed">518         public FileTime getLastModified(Path p) throws IOException {</span>
<span class="line-removed">519             // Timestamp only needed when examining repository for other JVMs,</span>
<span class="line-removed">520             // in which case an unprivileged mode should be used.</span>
<span class="line-removed">521             throw new InternalError(&quot;Should not reach here&quot;);</span>
522         }
523     }
<a name="16" id="anc16"></a><span class="line-removed">524 </span>
<span class="line-removed">525 </span>
526 }
<a name="17" id="anc17"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="17" type="hidden" />
</body>
</html>