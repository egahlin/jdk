<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff src/jdk.jfr/share/classes/jdk/jfr/consumer/EventStream.java</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="../ValueDescriptor.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="RecordingFile.java.sdiff.html" target="_top">next &gt;</a></center>    <h2>src/jdk.jfr/share/classes/jdk/jfr/consumer/EventStream.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, 2024, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.consumer;
 27 
 28 import java.io.IOException;
 29 import java.nio.file.Path;
<span class="line-removed"> 30 import java.security.AccessControlContext;</span>
<span class="line-removed"> 31 import java.security.AccessController;</span>
 32 import java.time.Duration;
 33 import java.time.Instant;
 34 import java.util.Collections;
 35 import java.util.Objects;
 36 import java.util.function.Consumer;
 37 
<span class="line-removed"> 38 import jdk.jfr.internal.SecuritySupport;</span>
 39 import jdk.jfr.internal.consumer.EventDirectoryStream;
 40 import jdk.jfr.internal.consumer.EventFileStream;
<span class="line-removed"> 41 import jdk.jfr.internal.consumer.FileAccess;</span>
 42 
 43 /**
 44  * Represents a stream of events.
 45  * &lt;p&gt;
 46  * A stream is a sequence of events and the way to interact with a stream is to
 47  * register actions. The {@code EventStream} interface is not to be implemented
 48  * and future versions of the JDK may prevent this completely.
 49  * &lt;p&gt;
 50  * To receive a notification when an event arrives, register an action using the
 51  * {@link #onEvent(Consumer)} method. To filter the stream for an event with a
 52  * specific name, use {@link #onEvent(String, Consumer)} method.
 53  * &lt;p&gt;
 54  * By default, the same {@code RecordedEvent} object can be used to
 55  * represent two or more distinct events. That object can be delivered
 56  * multiple times to the same action as well as to other actions. To use an
 57  * event object after the action is completed, the
 58  * {@link #setReuse(boolean)} method should be set to {@code false} so a
 59  * new object is allocated for each event.
 60  * &lt;p&gt;
 61  * Events are delivered in batches. To receive a notification when a batch is
</pre>
<hr />
<pre>
 96  *
 97  * {@snippet class=&quot;Snippets&quot; region=&quot;EventStreamOverview&quot;}
 98  * &lt;p&gt;
 99  * To start recording together with the stream, see {@link RecordingStream}.
100  *
101  * @since 14
102  */
103 public interface EventStream extends AutoCloseable {
104     /**
105      * Creates a stream from the repository of the current Java Virtual Machine
106      * (JVM).
107      * &lt;p&gt;
108      * By default, the stream starts with the next event flushed by Flight
109      * Recorder.
110      *
111      * @return an event stream, not {@code null}
112      *
113      * @throws IOException if a stream can&#39;t be opened, or an I/O error occurs
114      *         when trying to access the repository
115      */
<span class="line-removed">116     @SuppressWarnings(&quot;removal&quot;)</span>
117     public static EventStream openRepository() throws IOException {
<span class="line-removed">118         SecuritySupport.checkAccessFlightRecorder();</span>
119         return new EventDirectoryStream(
<span class="line-removed">120             AccessController.getContext(),</span>
121             null,
<span class="line-removed">122             SecuritySupport.PRIVILEGED,</span>
123             null,
124             Collections.emptyList(),
125             false
126         );
127     }
128 
129     /**
130      * Creates an event stream from a disk repository.
131      * &lt;p&gt;
132      * By default, the stream starts with the next event flushed by Flight
133      * Recorder.
134      * &lt;p&gt;
135      * Only trusted disk repositories should be opened.
136      *
137      * @param directory location of the disk repository, not {@code null}
138      *
139      * @return an event stream, not {@code null}
140      *
141      * @throws IOException if a stream can&#39;t be opened, or an I/O error occurs
142      *         when trying to access the repository
143      */
144     public static EventStream openRepository(Path directory) throws IOException {
145         Objects.requireNonNull(directory, &quot;directory&quot;);
<span class="line-removed">146         @SuppressWarnings(&quot;removal&quot;)</span>
<span class="line-removed">147         AccessControlContext acc = AccessController.getContext();</span>
148         return new EventDirectoryStream(
<span class="line-removed">149             acc,</span>
150             directory,
<span class="line-removed">151             FileAccess.UNPRIVILEGED,</span>
152             null,
153             Collections.emptyList(),
154             true
155         );
156     }
157 
158     /**
159      * Creates an event stream from a file.
160      * &lt;p&gt;
161      * By default, the stream starts with the first event in the file.
162      * &lt;p&gt;
163      * Only recording files from trusted sources should be opened.
164      *
165      * @param file location of the file, not {@code null}
166      *
167      * @return an event stream, not {@code null}
168      *
169      * @throws IOException if the file can&#39;t be opened, or an I/O error occurs
170      *         during reading
171      */
<span class="line-removed">172     @SuppressWarnings(&quot;removal&quot;)</span>
173     static EventStream openFile(Path file) throws IOException {
174         Objects.requireNonNull(file, &quot;file&quot;);
<span class="line-modified">175         return new EventFileStream(AccessController.getContext(), file);</span>
176     }
177 
178     /**
179      * Registers an action to perform when new metadata arrives in the stream.
180      *
181      * The event type of an event always arrives sometime before the actual event.
182      * The action must be registered before the stream is started.
183      * &lt;p&gt;
184      * The following example shows how to listen to new event types, register
185      * an action if the event type name matches a regular expression and increase a
186      * counter if a matching event is found. A benefit of using an action per
187      * event type, instead of the generic {@link #onEvent(Consumer)} method,
188      * is that a stream implementation can avoid reading events that are of no
189      * interest.
190      *
191      * {@snippet class = &quot;Snippets&quot; region = &quot;EventStreamMetadata&quot;}
192      *
193      * @implSpec The default implementation of this method is empty.
194      *
195      * @param action to perform, not {@code null}
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (c) 2019, 2025, Oracle and/or its affiliates. All rights reserved.</span>
  3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  4  *
  5  * This code is free software; you can redistribute it and/or modify it
  6  * under the terms of the GNU General Public License version 2 only, as
  7  * published by the Free Software Foundation.  Oracle designates this
  8  * particular file as subject to the &quot;Classpath&quot; exception as provided
  9  * by Oracle in the LICENSE file that accompanied this code.
 10  *
 11  * This code is distributed in the hope that it will be useful, but WITHOUT
 12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 14  * version 2 for more details (a copy is included in the LICENSE file that
 15  * accompanied this code).
 16  *
 17  * You should have received a copy of the GNU General Public License version
 18  * 2 along with this work; if not, write to the Free Software Foundation,
 19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 20  *
 21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 22  * or visit www.oracle.com if you need additional information or have any
 23  * questions.
 24  */
 25 
 26 package jdk.jfr.consumer;
 27 
 28 import java.io.IOException;
 29 import java.nio.file.Path;


 30 import java.time.Duration;
 31 import java.time.Instant;
 32 import java.util.Collections;
 33 import java.util.Objects;
 34 import java.util.function.Consumer;
 35 

 36 import jdk.jfr.internal.consumer.EventDirectoryStream;
 37 import jdk.jfr.internal.consumer.EventFileStream;

 38 
 39 /**
 40  * Represents a stream of events.
 41  * &lt;p&gt;
 42  * A stream is a sequence of events and the way to interact with a stream is to
 43  * register actions. The {@code EventStream} interface is not to be implemented
 44  * and future versions of the JDK may prevent this completely.
 45  * &lt;p&gt;
 46  * To receive a notification when an event arrives, register an action using the
 47  * {@link #onEvent(Consumer)} method. To filter the stream for an event with a
 48  * specific name, use {@link #onEvent(String, Consumer)} method.
 49  * &lt;p&gt;
 50  * By default, the same {@code RecordedEvent} object can be used to
 51  * represent two or more distinct events. That object can be delivered
 52  * multiple times to the same action as well as to other actions. To use an
 53  * event object after the action is completed, the
 54  * {@link #setReuse(boolean)} method should be set to {@code false} so a
 55  * new object is allocated for each event.
 56  * &lt;p&gt;
 57  * Events are delivered in batches. To receive a notification when a batch is
</pre>
<hr />
<pre>
 92  *
 93  * {@snippet class=&quot;Snippets&quot; region=&quot;EventStreamOverview&quot;}
 94  * &lt;p&gt;
 95  * To start recording together with the stream, see {@link RecordingStream}.
 96  *
 97  * @since 14
 98  */
 99 public interface EventStream extends AutoCloseable {
100     /**
101      * Creates a stream from the repository of the current Java Virtual Machine
102      * (JVM).
103      * &lt;p&gt;
104      * By default, the stream starts with the next event flushed by Flight
105      * Recorder.
106      *
107      * @return an event stream, not {@code null}
108      *
109      * @throws IOException if a stream can&#39;t be opened, or an I/O error occurs
110      *         when trying to access the repository
111      */

112     public static EventStream openRepository() throws IOException {

113         return new EventDirectoryStream(

114             null,

115             null,
116             Collections.emptyList(),
117             false
118         );
119     }
120 
121     /**
122      * Creates an event stream from a disk repository.
123      * &lt;p&gt;
124      * By default, the stream starts with the next event flushed by Flight
125      * Recorder.
126      * &lt;p&gt;
127      * Only trusted disk repositories should be opened.
128      *
129      * @param directory location of the disk repository, not {@code null}
130      *
131      * @return an event stream, not {@code null}
132      *
133      * @throws IOException if a stream can&#39;t be opened, or an I/O error occurs
134      *         when trying to access the repository
135      */
136     public static EventStream openRepository(Path directory) throws IOException {
137         Objects.requireNonNull(directory, &quot;directory&quot;);


138         return new EventDirectoryStream(

139             directory,

140             null,
141             Collections.emptyList(),
142             true
143         );
144     }
145 
146     /**
147      * Creates an event stream from a file.
148      * &lt;p&gt;
149      * By default, the stream starts with the first event in the file.
150      * &lt;p&gt;
151      * Only recording files from trusted sources should be opened.
152      *
153      * @param file location of the file, not {@code null}
154      *
155      * @return an event stream, not {@code null}
156      *
157      * @throws IOException if the file can&#39;t be opened, or an I/O error occurs
158      *         during reading
159      */

160     static EventStream openFile(Path file) throws IOException {
161         Objects.requireNonNull(file, &quot;file&quot;);
<span class="line-modified">162         return new EventFileStream(file);</span>
163     }
164 
165     /**
166      * Registers an action to perform when new metadata arrives in the stream.
167      *
168      * The event type of an event always arrives sometime before the actual event.
169      * The action must be registered before the stream is started.
170      * &lt;p&gt;
171      * The following example shows how to listen to new event types, register
172      * an action if the event type name matches a regular expression and increase a
173      * counter if a matching event is found. A benefit of using an action per
174      * event type, instead of the generic {@link #onEvent(Consumer)} method,
175      * is that a stream implementation can avoid reading events that are of no
176      * interest.
177      *
178      * {@snippet class = &quot;Snippets&quot; region = &quot;EventStreamMetadata&quot;}
179      *
180      * @implSpec The default implementation of this method is empty.
181      *
182      * @param action to perform, not {@code null}
</pre>
</td>
</tr>
</table>
<center><a href="../ValueDescriptor.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="RecordingFile.java.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>